!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const e={},t=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){const t=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),i=(null==a?void 0:a.nonce)||(null==a?void 0:a.getAttribute("nonce"));s=Promise.allSettled(n.map(n=>{if(n=function(e,t){return new URL(e,t).href}(n,o),n in e)return;e[n]=!0;const s=n.endsWith(".css"),a=s?'[rel="stylesheet"]':"";if(!!o)for(let e=t.length-1;e>=0;e--){const o=t[e];if(o.href===n&&(!s||"stylesheet"===o.rel))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const l=document.createElement("link");return l.rel=s?"stylesheet":"modulepreload",s||(l.as="script"),l.crossOrigin="",l.href=n,i&&l.setAttribute("nonce",i),document.head.appendChild(l),s?new Promise((e,t)=>{l.addEventListener("load",e),l.addEventListener("error",()=>t(new Error(`Unable to preload CSS for ${n}`)))}):void 0}))}function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(e=>{for(const t of e||[])"rejected"===t.status&&a(t.reason);return t().catch(a)})},n="presets";const o=new class{constructor(){this.db=null}async init(){return new Promise((e,t)=>{const o=indexedDB.open("CameraPresetsDB",1);o.onerror=()=>t(o.error),o.onsuccess=()=>{this.db=o.result,e()},o.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(n)){t.createObjectStore(n,{keyPath:"id"}).createIndex("type","type",{unique:!1})}}})}async saveModification(e,t){const o=this.db.transaction([n],"readwrite").objectStore(n);await o.put({id:`modified_${e}`,type:"modification",name:e,data:t,timestamp:Date.now()})}async saveNewPreset(e){const t=this.db.transaction([n],"readwrite").objectStore(n);await t.put({id:`new_${e.name}`,type:"new",name:e.name,data:e,timestamp:Date.now()})}async saveDeletion(e){const t=this.db.transaction([n],"readwrite").objectStore(n);await t.put({id:`deleted_${e}`,type:"deletion",name:e,timestamp:Date.now()})}async getAllModifications(){return new Promise((e,t)=>{const o=this.db.transaction([n],"readonly").objectStore(n).getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async clearAll(){return new Promise((e,t)=>{const o=this.db.transaction([n],"readwrite"),s=o.objectStore(n).clear();s.onsuccess=()=>e(),s.onerror=()=>t(s.error),o.onerror=()=>t(o.error)})}async clearFactoryPresetModifications(){return new Promise((e,t)=>{const o=this.db.transaction([n],"readwrite"),s=o.objectStore(n),a=s.getAll();a.onsuccess=()=>{const n=a.result,o=[];for(const e of n)if("modification"===e.type||"deletion"===e.type){const t=s.delete(e.id);o.push(new Promise((e,n)=>{t.onsuccess=()=>e(),t.onerror=()=>n(t.error)}))}Promise.all(o).then(()=>e()).catch(t)},a.onerror=()=>t(a.error),o.onerror=()=>t(o.error)})}async removeModification(e){const t=this.db.transaction([n],"readwrite").objectStore(n);await t.delete(`modified_${e}`),await t.delete(`deleted_${e}`)}},s="imported_presets";const a=new class{constructor(){this.db=null,this.importedPresets=[],this.isImportModalOpen=!1,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates=new Map}async init(){return new Promise((e,t)=>{const n=indexedDB.open("ImportedPresetsDB",1);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e()},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(s)||t.createObjectStore(s,{keyPath:"id",autoIncrement:!0})}})}async loadImportedPresets(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([s],"readonly").objectStore(s).getAll();n.onsuccess=()=>{this.importedPresets=n.result.map(e=>e.preset),e(this.importedPresets)},n.onerror=()=>{e([])}})}async saveImportedPresets(e){return this.db||await this.init(),new Promise(async(t,n)=>{const o=this.db.transaction([s],"readwrite").objectStore(s),a=o.clear();a.onsuccess=()=>{const s=e.map(e=>new Promise((t,n)=>{const s=o.add({preset:e});s.onsuccess=()=>t(),s.onerror=()=>n(s.error)}));Promise.all(s).then(()=>{this.importedPresets=e,t()}).catch(n)},a.onerror=()=>n(a.error)})}async loadPresetsFromFile(){try{const e=await fetch("./presets.json");if(!e.ok)throw new Error("Failed to load presets.json");const t=await e.json();return t.filter(e=>e.name&&e.message&&Array.isArray(e.category)).sort((e,t)=>e.name.localeCompare(t.name))}catch(e){throw new Error("Could not load presets.json file")}}getFilteredPresets(e){if(!this.importFilterText.trim())return e;const t=this.importFilterText.toLowerCase();return e.filter(e=>e.name.toLowerCase().includes(t))}async showPresetSelectionUI(e){return new Promise(t=>{this.isImportModalOpen=!0,this.currentImportScrollIndex=0,this.importFilterText="",this.checkboxStates.clear(),e.forEach(e=>{const t=this.importedPresets.some(t=>t.name===e.name);this.checkboxStates.set(e.name,t)});const n=document.createElement("div");n.className="styles-menu",n.style.display="flex",n.style.zIndex="10000",n.id="import-preset-modal";const o=document.createElement("div");o.className="styles-menu-content";const s=document.createElement("div");s.className="styles-menu-header",s.style.marginBottom="0",s.innerHTML=`\n        <h2 style="font-size: 14px;">Import (<span id="import-preset-count">${e.length}</span>)</h2>\n        <div class="menu-nav-buttons">\n          <button id="import-jump-to-top" class="menu-jump-button" title="Jump to top">‚Üë</button>\n          <button id="import-jump-to-bottom" class="menu-jump-button" title="Jump to bottom">‚Üì</button>\n          <button id="close-import-modal" class="close-button">√ó</button>\n        </div>\n      `;const a=document.createElement("div");a.className="styles-menu-scroll-container",a.id="import-scroll-container",a.style.paddingTop="0",a.style.paddingBottom="22px";const i=document.createElement("div");i.className="menu-section",i.style.cssText="position: sticky; top: 0; background: #1a1a1a; z-index: 10; padding: 5px 0; margin: 0; border-bottom: 1px solid #333;",i.innerHTML='\n        <input type="text" id="import-preset-filter" class="style-filter" placeholder="Filter..." style="width: 100%; margin: 0; height: 24px; font-size: 12px;">\n      ';const l=document.createElement("div");l.className="menu-section",l.id="import-presets-section",l.style.margin="0";const c=document.createElement("div");c.className="menu-list",c.id="import-presets-list";const r=()=>{const t=this.getFilteredPresets(e),n=document.getElementById("import-preset-count");n&&(n.textContent=t.length),c.innerHTML="",t.forEach((e,t)=>{const n=document.createElement("button");n.className="menu-item",n.dataset.presetIndex=t,n.dataset.presetName=e.name,n.style.cssText="display: flex; align-items: center; padding: 6px 15px; min-height: 30px; width: 100%; justify-content: flex-start; margin-bottom: 2px;";const o=document.createElement("input");o.type="checkbox",o.id=`import-preset-${t}`,o.checked=this.checkboxStates.get(e.name)||!1,o.style.cssText="\n            width: 18px;\n            height: 18px;\n            min-width: 18px;\n            min-height: 18px;\n            margin-right: 10px;\n            cursor: pointer;\n            accent-color: #4CAF50;\n            flex-shrink: 0;\n          ",o.onclick=t=>{t.stopPropagation(),this.checkboxStates.set(e.name,o.checked)};const s=document.createElement("span");s.className="menu-item-name",s.textContent=e.name,s.style.cssText="flex: 1; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; color: #000; font-size: 12px; display: flex; align-items: center;";const a=this.importedPresets.find(t=>t.name===e.name);if(a){if(a.message!==e.message){const e=document.createElement("span");e.className="preset-ticket preset-ticket-updated",e.textContent="UPDATED",s.appendChild(e)}}else{const e=document.createElement("span");e.className="preset-ticket preset-ticket-new",e.textContent="NEW",s.appendChild(e)}n.appendChild(o),n.appendChild(s),n.onclick=t=>{t.target!==o&&(o.checked=!o.checked,this.checkboxStates.set(e.name,o.checked))},c.appendChild(n)}),d()},d=()=>{const e=c.querySelectorAll(".menu-item");if(e.forEach(e=>e.classList.remove("menu-selected")),this.currentImportScrollIndex>=0&&this.currentImportScrollIndex<e.length){const t=e[this.currentImportScrollIndex];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}};l.appendChild(c);const m=document.createElement("div");m.style.cssText="\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  background: #1a1a1a;\n  z-index: 20;\n  padding: 2px;\n  border-top: 1px solid #333;\n  display: flex;\n  gap: 3px;\n",m.innerHTML='\n  <button id="select-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">\n    ‚úì All\n  </button>\n  <button id="deselect-all-presets" style="flex: 1; padding: 0; background: #444; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">\n    ‚úó None\n  </button>\n  <button id="confirm-import-presets" style="flex: 1; padding: 0; background: #4CAF50; color: white; border: none; border-radius: 2px; font-size: 10px; font-weight: bold; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">\n    Import\n  </button>\n  <button id="cancel-import-presets" style="flex: 1; padding: 0; background: #666; color: white; border: none; border-radius: 2px; font-size: 10px; cursor: pointer; height: 16px !important; min-height: 0 !important; line-height: 16px; box-sizing: border-box !important;">\n    Cancel\n  </button>\n',a.appendChild(i),a.appendChild(l),o.appendChild(s),o.appendChild(a),n.appendChild(o),n.appendChild(m),document.body.appendChild(n),r();document.getElementById("import-preset-filter").addEventListener("input",e=>{this.importFilterText=e.target.value,this.currentImportScrollIndex=0,r()}),document.getElementById("select-all-presets").onclick=()=>{this.getFilteredPresets(e).forEach(e=>{this.checkboxStates.set(e.name,!0)}),r()},document.getElementById("deselect-all-presets").onclick=()=>{this.getFilteredPresets(e).forEach(e=>{this.checkboxStates.set(e.name,!1)}),r()};const u=()=>{this.isImportModalOpen=!1,document.body.removeChild(n)};document.getElementById("close-import-modal").onclick=()=>{u(),t(null)},document.getElementById("cancel-import-presets").onclick=()=>{u(),t(null)},document.getElementById("confirm-import-presets").onclick=()=>{const n=e.filter(e=>!0===this.checkboxStates.get(e.name));u(),t(n)},document.getElementById("import-jump-to-top").onclick=()=>{a.scrollTop=0,this.currentImportScrollIndex=0,d()},document.getElementById("import-jump-to-bottom").onclick=()=>{a.scrollTop=a.scrollHeight;const e=c.querySelectorAll(".menu-item");this.currentImportScrollIndex=e.length-1,d()},this.scrollImportUp=()=>{0!==c.querySelectorAll(".menu-item").length&&(this.currentImportScrollIndex=Math.max(0,this.currentImportScrollIndex-1),d())},this.scrollImportDown=()=>{const e=c.querySelectorAll(".menu-item");0!==e.length&&(this.currentImportScrollIndex=Math.min(e.length-1,this.currentImportScrollIndex+1),d())},a.style.overflowY="auto"})}async import(){try{const e=await this.loadPresetsFromFile();if(0===e.length)return{success:!1,message:"No presets found in presets.json"};const t=await this.showPresetSelectionUI(e);if(null===t)return{success:!1,message:"cancelled"};if(0===t.length)return{success:!1,message:"No presets selected"};const n=new Map(this.importedPresets.map(e=>[e.name,e]));let o=0,s=0;t.forEach(e=>{n.has(e.name)?(n.set(e.name,e),o++):(n.set(e.name,e),s++)});const a=Array.from(n.values());await this.saveImportedPresets(a);let i="";return i=o>0&&s>0?`Updated ${o}, imported ${s} new. Total: ${a.length}`:o>0?`Updated ${o} preset(s). Total: ${a.length}`:`Imported ${s} new preset(s). Total: ${a.length}`,{success:!0,message:i,updated:o,new:s,total:a.length}}catch(e){return{success:!1,message:e.message}}}async deletePreset(e){const t=this.importedPresets.findIndex(t=>t.name===e);return t>=0&&(this.importedPresets.splice(t,1),await this.saveImportedPresets(this.importedPresets),!0)}async clearImportedPresets(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([s],"readwrite").objectStore(s).clear();n.onsuccess=()=>{this.importedPresets=[],e()},n.onerror=()=>t(n.error)})}getImportedPresets(){return this.importedPresets}};let i,l,c,r,d,m=[],u=null,g=null;window.alert=function(e,t="info"){return new Promise(t=>{const n=document.getElementById("custom-alert-modal"),o=document.getElementById("custom-alert-message"),s=document.getElementById("custom-alert-buttons");o.textContent=e,s.innerHTML='<button class="custom-alert-btn custom-alert-btn-primary" id="custom-alert-ok">OK</button>',n.style.display="flex";const a=document.getElementById("custom-alert-ok"),i=()=>{n.style.display="none",a.removeEventListener("click",i),t()};a.addEventListener("click",i)})},window.confirm=function(e,t={}){return new Promise(n=>{const o=document.getElementById("custom-alert-modal"),s=document.getElementById("custom-alert-message"),a=document.getElementById("custom-alert-buttons");s.textContent=e;const i=t.yesText||"Yes",l=t.noText||"No",c=t.danger?"custom-alert-btn-danger":"custom-alert-btn-primary";a.innerHTML=`\n      <button class="custom-alert-btn custom-alert-btn-secondary" id="custom-confirm-no">${l}</button>\n      <button class="custom-alert-btn ${c}" id="custom-confirm-yes">${i}</button>\n    `,o.style.display="flex";const r=document.getElementById("custom-confirm-yes"),d=document.getElementById("custom-confirm-no"),m=()=>{o.style.display="none",r.removeEventListener("click",m),d.removeEventListener("click",u),n(!0)},u=()=>{o.style.display="none",r.removeEventListener("click",m),d.removeEventListener("click",u),n(!1)};r.addEventListener("click",m),d.addEventListener("click",u)})};const p=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"SXGA+ (1400x1050)",width:1400,height:1050},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080},{name:"HD (3264x2448)",width:3264,height:2448}];let y=0;const h="r1_camera_resolution",f=[{name:"VGA (640x480)",width:640,height:480},{name:"SVGA (800x600)",width:800,height:600},{name:"XGA (1024x768)",width:1024,height:768},{name:"SXGA (1280x960)",width:1280,height:960},{name:"UXGA (1600x1200)",width:1600,height:1200},{name:"2K (2048x1080)",width:2048,height:1080}];let E=0;const I="r1_import_resolution";let v=0,b=[],w=!1,B=1,T=!1,x=0,S=1,C=!1,L=5,O=500,A=!1;const k={1:{delay:800,label:"Slow"},2:{delay:500,label:"Medium"},3:{delay:300,label:"Fast"}},M="r1_camera_burst_settings",N="r1_camera_timer_settings",P="r1_camera_last_preset";let D=!1,R=null,q=10,H=!1,$=[3,5,10],U=1;const _={1:{seconds:1,label:"1s"},2:{seconds:3,label:"3s"},3:{seconds:5,label:"5s"},4:{seconds:10,label:"10s"},5:{seconds:30,label:"30s"},6:{seconds:60,label:"1m"},7:{seconds:300,label:"5m"},8:{seconds:600,label:"10m"},9:{seconds:1800,label:"30m"},10:{seconds:3600,label:"1h"}};let j="",F=!1;const V="r1_camera_master_prompt",G="r1_camera_master_prompt_enabled",z="r1_camera_aspect_ratio";let J="none";const W="r1_camera_selection_history";let Y={};let X=!1,Q=!1,Z=null,K=null,ee=30,te=.1,ne=!0,oe=2,se=!1,ae=3;const ie="r1_camera_motion_settings";let le=null;const ce={1:{seconds:3,label:"3s"},2:{seconds:10,label:"10s"},3:{seconds:30,label:"30s"},4:{seconds:60,label:"1m"},5:{seconds:300,label:"5m"},6:{seconds:600,label:"10m"},7:{seconds:900,label:"15m"},8:{seconds:1800,label:"30m"}};let re=!1;const de="r1_camera_no_magic_mode";let me,ue,ge=!1,pe=-1,ye=null,he=0,fe=!1,Ee=!1,Ie=null,ve=!1,be=!1,we=0,Be=0,Te=0,xe=!1,Se=!1,Ce=!1,Le=!1,Oe=!1,Ae=!1,ke=!1,Me=-1;const Ne="images";let Pe=null,De=[];const Re="r1_gallery_sort_order";let qe=-1,He=1,$e=!1,Ue=0,_e=1,je=1;let Fe=null,Ve=null,Ge="newest",ze=!1,Je=new Set,We=!1,Ye=[],Xe=null,Qe="",Ze="",Ke=0,et="",tt="",nt="",ot=!1,st=!1,at=!1,it=null,lt=null,ct=!1;const rt={transform:"Take a picture and transform the image into [DESCRIBE TRANSFORMATION]. [ADD SPECIFIC DETAILS ABOUT STYLE, APPEARANCE, COLORS, ETC.]",transform_subject:"Take a picture and transform the subject into [WHAT THE SUBJECT BECOMES]. Preserve the subject's recognizable facial structure and identity. [ADD DETAILS ABOUT NEW APPEARANCE, ENVIRONMENT, LIGHTING].",convert:"Take a picture and convert the scene into [DESCRIBE NEW FORMAT/MEDIUM]. [ADD DETAILS ABOUT MATERIALS, TEXTURES, SCALE].",style:"Take a picture in the style of [ARTISTIC STYLE/ARTIST]. [ADD DETAILS ABOUT TECHNIQUE, COLORS, COMPOSITION].",place:"Take a picture and place the subject in [DESCRIBE SCENE/LOCATION]. [ADD DETAILS ABOUT LIGHTING, ATMOSPHERE, INTEGRATION].",recreate:"Take a picture and recreate [FAMOUS WORK/SCENE]. Replace [DESCRIBE WHAT TO REPLACE]. Preserve the iconic [DESCRIBE KEY ELEMENTS TO KEEP].",render:"Take a picture and render it as [FORMAT/MEDIUM]. [ADD DETAILS ABOUT APPEARANCE, TEXTURE, TECHNICAL SPECIFICS].",make:"Take a picture and make the subject into [CHARACTER/CREATURE]. [ADD DETAILS ABOUT APPEARANCE, TRAITS, SETTING]. Make it photorealistic.",analyze:"Analyze the image and [DESCRIBE WHAT TO ANALYZE/EXTRACT]. [ADD DETAILS ABOUT OUTPUT FORMAT] and email it to me.",random_even_odd:"Take a picture and transform [DESCRIBE BASE TRANSFORMATION].\n\nSELECTION (CRITICAL):\n- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT\n- If the RANDOM SEED ends in an EVEN number (0,2,4,6,8): SELECT Option A\n- If the RANDOM SEED ends in an ODD number (1,3,5,7,9): SELECT Option B\n\nIf Option A:\n[DESCRIBE WHAT HAPPENS IN OPTION A - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]\n\nIf Option B:\n[DESCRIBE WHAT HAPPENS IN OPTION B - BE SPECIFIC ABOUT VISUAL DETAILS, STYLE, SETTING, ETC.]\n\n[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO BOTH OPTIONS - LIGHTING, QUALITY, PRESERVATION, ETC.]",random_last_digit:"Take a picture and transform [DESCRIBE BASE TRANSFORMATION].\n\nSELECTION (CRITICAL):\n- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT\n- If none is specified, SELECT EXACTLY ONE using LAST DIGIT modulo [NUMBER 2-10]:\n  - 0: [OPTION 1 DESCRIPTION]\n  - 1: [OPTION 2 DESCRIPTION]\n  - 2: [OPTION 3 DESCRIPTION]\n  - 3: [OPTION 4 DESCRIPTION]\n  - 4: [OPTION 5 DESCRIPTION]\n  - 5: [OPTION 6 DESCRIPTION]\n  - 6: [OPTION 7 DESCRIPTION]\n  - 7: [OPTION 8 DESCRIPTION]\n  - 8: [OPTION 9 DESCRIPTION]\n  - 9: [OPTION 10 DESCRIPTION]\n\n[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS - STYLE, QUALITY, TECHNICAL DETAILS, ETC.]\n\nIMPORTANT:\n- Replace [NUMBER 2-10] with the actual number of options you have (between 2 and 10)\n- Remove any unused option lines (e.g., if you only have 5 options, remove lines 5-9)\n- Each option should be a distinct visual variation or transformation\n- For exactly 10 options, use LAST DIGIT modulo 10 (covers digits 0-9)",random_last_two:"Take a picture and transform [DESCRIBE BASE TRANSFORMATION].\n\nSELECTION (CRITICAL):\n- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT\n- If none is specified, SELECT EXACTLY ONE using LAST TWO DIGITS modulo [NUMBER 11-99]:\n  - 0: [OPTION 1 DESCRIPTION]\n  - 1: [OPTION 2 DESCRIPTION]\n  - 2: [OPTION 3 DESCRIPTION]\n  - 3: [OPTION 4 DESCRIPTION]\n  - 4: [OPTION 5 DESCRIPTION]\n  - 5: [OPTION 6 DESCRIPTION]\n  - 6: [OPTION 7 DESCRIPTION]\n  - 7: [OPTION 8 DESCRIPTION]\n  - 8: [OPTION 9 DESCRIPTION]\n  - 9: [OPTION 10 DESCRIPTION]\n  - 10: [OPTION 11 DESCRIPTION]\n  - 11: [OPTION 12 DESCRIPTION]\n  - 12: [OPTION 13 DESCRIPTION]\n  - 13: [OPTION 14 DESCRIPTION]\n  - 14: [OPTION 15 DESCRIPTION]\n  - 15: [OPTION 16 DESCRIPTION]\n  - 16: [OPTION 17 DESCRIPTION]\n  - 17: [OPTION 18 DESCRIPTION]\n  - 18: [OPTION 19 DESCRIPTION]\n  - 19: [OPTION 20 DESCRIPTION]\n  - 20: [OPTION 21 DESCRIPTION]\n\n[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]\n\nIMPORTANT:\n- Replace [NUMBER 11-99] with the actual number of options (between 11 and 99)\n- Add or remove option lines to match your number of options\n- Use LAST TWO DIGITS only when you have MORE than 10 options\n- Ensure the colon (:) comes immediately after the modulo number\n- Use exactly 2 spaces before each dash (-)\n- Keep all options in one continuous list with no blank lines",random_last_three:"Take a picture and transform [DESCRIBE BASE TRANSFORMATION].\n\nSELECTION (CRITICAL):\n- If an external master prompt specifies [WHAT CAN BE SPECIFIED], USE THAT\n- If none is specified, SELECT EXACTLY ONE using LAST THREE DIGITS modulo [NUMBER 100+]:\n  - 0: [OPTION 1 DESCRIPTION]\n  - 1: [OPTION 2 DESCRIPTION]\n  - 2: [OPTION 3 DESCRIPTION]\n  - 3: [OPTION 4 DESCRIPTION]\n  - 4: [OPTION 5 DESCRIPTION]\n  (continue numbering for all your options)\n  - 98: [OPTION 99 DESCRIPTION]\n  - 99: [OPTION 100 DESCRIPTION]\n  - 100: [OPTION 101 DESCRIPTION]\n\n[ADD ANY ADDITIONAL INSTRUCTIONS THAT APPLY TO ALL OPTIONS]\n\nIMPORTANT:\n- Replace [NUMBER 100+] with the actual number of options (101 or more)\n- Add option lines for every option you want to include\n- Use LAST THREE DIGITS only when you have 101 or more options\n- Ensure the colon (:) comes immediately after the modulo number\n- Use exactly 2 spaces before each dash (-)\n- Keep all options in one continuous list with no blank lines\n- This format is ideal for large preset collections like 120 Star Trek species or 150 character types",custom:""};let dt=[],mt=[],ut=!1,gt=0,pt=-1,yt=navigator.onLine,ht=[],ft=!1,Et=null,It=0;const vt="r1_camera_queue";let bt,wt,Bt;const Tt="r1_camera_styles";let xt=[];const St="r1_camera_favorites",Ct="r1_camera_visible_presets";let Lt=[],Ot=!1,At=0,kt="",Mt=!0;function Nt(e){ye&&(clearTimeout(ye),ye=null),me||(me=document.getElementById("style-reveal"),ue=document.getElementById("style-reveal-text")),me&&ue&&(ue.textContent=re?"‚ö° NO MAGIC MODE":e,me.style.display="block",ye=setTimeout(()=>{me&&(me.style.display="none"),ye=null},1200))}function Pt(){return new Promise((e,t)=>{const n=indexedDB.open("R1CameraGallery",1);n.onerror=()=>{t(n.error)},n.onsuccess=()=>{Pe=n.result,e(Pe)},n.onupgradeneeded=e=>{if(Pe=e.target.result,!Pe.objectStoreNames.contains(Ne)){Pe.createObjectStore(Ne,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}}})}async function Dt(){try{Pe||await Pt(),De=[];const e=Pe.transaction([Ne],"readonly"),t=e.objectStore(Ne).getAll();return new Promise((e,n)=>{t.onsuccess=()=>{De=t.result||[];const n=localStorage.getItem(Re);n&&(Ge=n),De.sort((e,t)=>t.timestamp-e.timestamp),e()},t.onerror=()=>{De=[],n(t.error)}})}catch(e){De=[]}}async function Rt(e){try{Pe||await Pt();const t=Pe.transaction([Ne],"readwrite"),n=t.objectStore(Ne).add(e);return new Promise((e,t)=>{n.onsuccess=()=>{e()},n.onerror=()=>{t(n.error)}})}catch(t){}}async function qt(e){try{Pe||await Pt();const t=Pe.transaction([Ne],"readwrite"),n=t.objectStore(Ne).delete(e);return new Promise((e,t)=>{n.onsuccess=()=>{e()},n.onerror=()=>{t(n.error)}})}catch(t){}}async function Ht(e){const t={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:e,timestamp:Date.now()};De.unshift(t),await Rt(t)}function $t(){var e;return function(e){const t=[...e];return"newest"===Ge?t.sort((e,t)=>t.timestamp-e.timestamp):t.sort((e,t)=>e.timestamp-t.timestamp),t}((e=De,Fe||Ve?e.filter(e=>{const t=new Date(e.timestamp);t.setHours(0,0,0,0);const n=t.getTime();let o=!0,s=!0;return Fe&&(o=n>=new Date(Fe).getTime()),Ve&&(s=n<=new Date(Ve).getTime()),o&&s}):e))}async function Ut(){Ao(),To(),c&&"block"===c.style.display&&Ho(),await Dt();const e=document.getElementById("gallery-modal"),t=document.getElementById("gallery-grid"),n=document.getElementById("gallery-pagination"),o=document.getElementById("page-info"),s=document.getElementById("prev-page"),a=document.getElementById("next-page"),i=document.getElementById("gallery-count");i&&(i.textContent=De.length);const l=document.getElementById("gallery-sort-order");l&&(l.value=Ge);const r=$t();if(0===r.length)t.innerHTML='<div class="gallery-empty">No photos match the selected filter.</div>',n.style.display="none";else{const e=Math.ceil(r.length/16);je=Math.min(je,e);const i=16*(je-1),l=Math.min(i+16,r.length),c=r.slice(i,l),d=document.createDocumentFragment();c.forEach(e=>{const t=document.createElement("div");if(t.className="gallery-item",ze&&Je.has(e.id)&&t.classList.add("selected"),ze){const n=document.createElement("input");n.type="checkbox",n.className="gallery-item-checkbox",n.checked=Je.has(e.id),n.addEventListener("click",t=>{t.stopPropagation(),mn(e.id)}),t.appendChild(n)}const n=document.createElement("img");n.src=e.imageBase64,n.alt="Gallery image",n.loading="lazy",t.appendChild(n),t.onclick=()=>{if(ze)mn(e.id),Ut();else{zt(De.findIndex(t=>t.id===e.id))}},d.appendChild(t)}),t.innerHTML="",t.appendChild(d),e>1?(n.style.display="flex",o.textContent=`Page ${je} of ${e}`,s.disabled=1===je,a.disabled=je===e):n.style.display="none"}e.style.display="flex"}async function _t(){if(document.getElementById("gallery-modal").style.display="none",je=1,await ko(),r&&(r.style.display="block"),re)r&&(r.textContent="‚ö° NO MAGIC MODE"),Nt("‚ö° NO MAGIC MODE");else if(D||C||Q||X||We){let e="";D?e="‚è±Ô∏è Timer Mode":C?e="üì∏ Burst Mode":Q?e="üëÅÔ∏è Motion Detection":X&&(e="üé≤ Random Mode"),r&&(r.textContent=`${e} ‚Ä¢ ${dt[gt]?dt[gt].name:""}`),Nt(e)}else qo()}function jt(){const e=$t(),t=Math.ceil(e.length/16);je<t&&(je++,Ut())}function Ft(){je>1&&(je--,Ut())}function Vt(){je=1,Ut()}function Gt(e,t){const n="start"===e?"gallery-start-date-btn":"gallery-end-date-btn",o=document.getElementById(n);if(!o)return;const s=o.querySelector(".date-button-text");if(s)if(t){const e=new Date(t+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});s.textContent=e,o.classList.add("has-date")}else s.textContent="start"===e?"Start":"End",o.classList.remove("has-date")}function zt(e){if(e<0||e>=De.length)return;qe=e;const t=De[e],n=document.getElementById("image-viewer"),o=document.getElementById("viewer-image"),s=document.getElementById("viewer-prompt");o.src=t.imageBase64,o.style.transform="scale(1) translate(0, 0)",He=1,s.value="";const a=document.getElementById("mp-viewer-button");a&&(F?a.classList.add("enabled"):a.classList.remove("enabled")),n.style.display="flex",document.getElementById("gallery-modal").style.display="none"}function Jt(){document.getElementById("image-viewer").style.display="none",qe=-1,He=1;document.getElementById("gallery-modal").style.display="flex",Ut()}async function Wt(){if(!(qe<0||qe>=De.length)&&await confirm("Delete this image from gallery?")){const e=De[qe];await qt(e.id),De.splice(qe,1),document.getElementById("image-viewer").style.display="none",qe=-1,He=1,Ut()}}function Yt(){const e=document.getElementById("preset-selector");We=!1,Ye=[];const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none");const n=e.querySelector(".preset-selector-header h3");n&&(n.innerHTML='Select Preset (<span id="preset-count">0</span>)'),sn();const o=document.getElementById("preset-count");o&&(o.textContent=dt.length),e.style.display="flex",be=!0,we=0,Qt(),setTimeout(()=>{const e=document.getElementById("preset-list");e&&Ke>0&&(e.scrollTop=Ke)},50)}function Xt(){const e=document.getElementById("preset-list");e&&(Ke=e.scrollTop),document.getElementById("preset-selector").style.display="none",Ze="",nt="",document.getElementById("preset-filter").value="",be=!1,we=0;const t=document.getElementById("preset-selector-category-hint");t&&(t.style.display="none"),We=!1}function Qt(){const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(0!==t.length&&(t.forEach(e=>{e.classList.remove("preset-selected")}),we>=0&&we<t.length)){const e=t[we];e.classList.add("preset-selected"),e.scrollIntoView({behavior:"smooth",block:"nearest"});const n=e.querySelector(".preset-name").textContent,o=dt.find(e=>e.name===n),s=document.getElementById("preset-selector-category-hint");s&&o&&o.category&&!at?(s.innerHTML="",s.style.display="block",o.category.forEach((e,t)=>{const n=document.createElement("span");if(n.textContent=e,n.style.cursor="pointer",n.style.padding="0 2px",nt===e&&(n.style.textDecoration="underline",n.style.fontWeight="bold"),n.onclick=t=>{t.stopPropagation(),nt=nt===e?"":e,we=0,sn()},s.appendChild(n),t<o.category.length-1){const e=document.createElement("span");e.textContent=", ",s.appendChild(e)}})):s&&(s.style.display="none")}}function Zt(){const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");if(0!==t.length&&(t.forEach(e=>{e.classList.remove("menu-selected")}),Be>=0&&Be<t.length)){const e=t[Be];e.classList.add("menu-selected"),e.scrollIntoView({behavior:"smooth",block:"nearest"})}}function Kt(e){if(e.forEach(e=>e.classList.remove("menu-selected")),Te>=0&&Te<e.length){const t=e[Te];t.classList.add("menu-selected"),t.scrollIntoView({behavior:"smooth",block:"nearest"})}}function en(){if(!ke)return;const e=document.getElementById("preset-builder-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}function tn(){if(!ke)return;const e=document.getElementById("preset-builder-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".preset-builder-form");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}function nn(){const e=document.getElementById("style-editor");if(!e||"flex"!==e.style.display)return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.max(0,t.scrollTop-100):n&&(n.scrollTop=Math.max(0,n.scrollTop-200))}function on(){const e=document.getElementById("style-editor");if(!e||"flex"!==e.style.display)return;const t=document.getElementById("style-message"),n=e.querySelector(".style-editor-body");document.activeElement===t?t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+100):n&&(n.scrollTop=Math.min(n.scrollHeight-n.clientHeight,n.scrollTop+200))}function sn(){const e=document.getElementById("preset-list");e.innerHTML="";const t=dt.filter(e=>Lt.includes(e.name)).filter(e=>{if(Ze){const t=Ze.toLowerCase(),n=e.category&&e.category.some(e=>e.toLowerCase().includes(t));if(!(e.name.toLowerCase().includes(t)||e.message.toLowerCase().includes(t)||n))return!1}return!nt||e.category&&e.category.includes(nt)}).sort((e,t)=>e.name.localeCompare(t.name)),n=[...t.filter(e=>Ln(e.name)),...t.filter(e=>!Ln(e.name))];if(0===n.length)return void(e.innerHTML='<div class="preset-empty">No presets found</div>');n.forEach(t=>{const n=document.createElement("div");n.className="preset-item";const o=document.createElement("div");o.className="preset-name",o.textContent=t.name;const s=document.createElement("div");s.className="preset-description preset-description-hidden",s.textContent=t.message,n.appendChild(o),n.appendChild(s),n.onclick=()=>{s.classList.contains("preset-description-hidden")?s.classList.remove("preset-description-hidden"):async function(e){if(We){const t=Ye.findIndex(t=>t.name===e.name);return t>-1?Ye.splice(t,1):Ye.push(e),void pn()}if(window.batchProcessingActive){window.batchProcessingActive=!1;const t=window.batchImagesToProcess;window.batchImagesToProcess=null,Xt();return document.getElementById("preset-selector").querySelector(".preset-selector-header h3").textContent="Select Preset",void(await async function(e,t){const n=t||Array.from(Je),o=n.length,s=document.createElement("div");s.className="batch-progress-overlay",s.innerHTML=`\n    <div class="batch-progress-text">Processing <span id="batch-current">0</span> / ${o}</div>\n    <div class="batch-progress-bar">\n      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>\n    </div>\n  `,document.body.appendChild(s);let a=0;for(const l of n){const t=De.find(e=>e.id===l);if(t)try{const n=cs(e.message,e.name,e);"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({message:n,pluginId:"com.r1.pixelart",imageBase64:t.imageBase64})),a++,document.getElementById("batch-current").textContent=a,document.getElementById("batch-progress-fill").style.width=a/o*100+"%",await new Promise(e=>setTimeout(e,3e3))}catch(i){}}document.body.removeChild(s),ze=!1,Je.clear(),ln(),alert(`Batch processing complete! ${a} of ${o} images submitted.`)}(e,t))}document.getElementById("viewer-prompt").value=e.message,Xt()}(t)},e.appendChild(n)});const o=document.getElementById("preset-count");o&&(o.textContent=n.length)}function an(){if(qe<0||qe>=De.length)return void alert("No image selected");let e=document.getElementById("viewer-prompt").value.trim(),t="Custom Prompt",n=null;if(!e){const o=On(),s=dt[o];e=s.message,t=s.name,n=s,alert(`Using random preset: ${t}`)}const o=De[qe];"undefined"!=typeof PluginMessageHandler?(PluginMessageHandler.postMessage(JSON.stringify({message:cs(e,t,n),pluginId:"com.r1.pixelart",imageBase64:o.imageBase64})),alert("Magic transform submitted! You can submit again with a different prompt.")):alert("Magic transform sent: "+e.substring(0,50)+"...")}function ln(){ze=!ze;const e=document.getElementById("batch-mode-toggle"),t=document.getElementById("batch-controls"),n=document.getElementById("batch-action-bar");ze?(e.textContent="Done",e.classList.add("active"),t.style.display="flex",n.style.display="flex",Je.clear(),cn(),Ut()):(e.textContent="Select",e.classList.remove("active"),t.style.display="none",n.style.display="none",Je.clear(),Ut())}function cn(){const e=document.getElementById("batch-selected-count"),t=document.getElementById("batch-apply-preset"),n=document.getElementById("batch-delete");e.textContent=`${Je.size} selected`,t.disabled=0===Je.size,n&&(n.disabled=0===Je.size)}function rn(){const e=$t();Je.clear(),e.forEach(e=>Je.add(e.id)),cn(),Ut()}function dn(){Je.clear(),cn(),Ut()}function mn(e){Je.has(e)?Je.delete(e):Je.add(e),cn()}async function un(){if(0===Je.size)return;const e=document.getElementById("preset-selector");e.querySelector(".preset-selector-header h3").textContent=`Select Preset (${Je.size} images)`;const t=Array.from(Je);window.batchProcessingActive=!0,window.batchImagesToProcess=t,sn(),e.style.display="flex",be=!0,we=0,Qt()}async function gn(){if(0===Je.size)return;const e=Je.size;if(!(await confirm(`Are you sure you want to delete ${e} selected image${e>1?"s":""}? This cannot be undone.`)))return;const t=Array.from(Je),n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`\n    <div class="batch-progress-text">Deleting <span id="batch-current">0</span> / ${e}</div>\n    <div class="batch-progress-bar">\n      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>\n    </div>\n  `,document.body.appendChild(n);let o=0;for(const a of t)try{await qt(a),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=o/e*100+"%"}catch(s){}document.body.removeChild(n),ze=!1,Je.clear(),await Dt(),ln(),alert(`${o} of ${e} image${o>1?"s":""} deleted successfully.`)}function pn(){document.getElementById("preset-list").querySelectorAll(".preset-item").forEach(e=>{const t=e.querySelector(".preset-name").textContent;Ye.some(e=>e.name===t)?(e.style.background="#e8f5e9",e.style.border="2px solid #4CAF50"):(e.style.background="",e.style.border="")});const e=document.getElementById("multi-preset-count");e&&(e.textContent=`(${Ye.length} selected)`)}function yn(){We=!1,Xe=null,Ye=[];const e=document.getElementById("multi-preset-controls");e&&(e.style.display="none");document.querySelector(".preset-selector-header h3").textContent="Select Preset",Xt()}async function hn(){if(0===Ye.length)return void alert("Please select at least one preset");if(!Xe)return void alert("No image selected");const e=De.find(e=>e.id===Xe);if(!e)return void alert("Image not found");const t=[...Ye];yn();const n=document.createElement("div");n.className="batch-progress-overlay",n.innerHTML=`\n    <div class="batch-progress-text">Applying preset <span id="batch-current">0</span> / ${t.length}</div>\n    <div class="batch-progress-bar">\n      <div class="batch-progress-fill" id="batch-progress-fill" style="width: 0%"></div>\n    </div>\n  `,document.body.appendChild(n);let o=0;for(const a of t)try{const n=cs(a.message,a.name,a);"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({message:n,pluginId:"com.r1.pixelart",imageBase64:e.imageBase64})),o++,document.getElementById("batch-current").textContent=o,document.getElementById("batch-progress-fill").style.width=o/t.length*100+"%",await new Promise(e=>setTimeout(e,3e3))}catch(s){}document.body.removeChild(n),alert(`${o} preset${o>1?"s":""} applied successfully!`)}function fn(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function En(){if(!fe)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(0===t.length)return;t.forEach(e=>{e.classList.remove("menu-selected")}),he=Math.max(0,Math.min(he,t.length-1));const n=t[he];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const e=parseInt(n.dataset.index),t=dt[e],o=document.getElementById("menu-category-hint");o&&t&&t.category&&!ot?(o.innerHTML="",o.style.display="block",t.category.forEach((e,n)=>{const s=document.createElement("span");if(s.textContent=e,s.style.cursor="pointer",s.style.padding="0 2px",tt===e&&(s.style.textDecoration="underline",s.style.fontWeight="bold"),s.onclick=t=>{t.stopPropagation(),tt=tt===e?"":e,he=0,ds()},o.appendChild(s),n<t.category.length-1){const e=document.createElement("span");e.textContent=", ",o.appendChild(e)}})):o&&(o.style.display="none")}}async function In(){await o.init(),await a.init();const e=(await a.loadImportedPresets()).length>0,t=(await o.getAllModifications()).length>0;e||t?dt=await bn():(dt=[],setTimeout(async()=>{await confirm("Welcome! You should import presets to get started. Would you like to import now?")&&(document.getElementById("menu-button").click(),setTimeout(()=>{document.getElementById("settings-menu-button").click(),setTimeout(()=>{document.getElementById("import-presets-button").click()},100)},100))},500));const n=localStorage.getItem(Tt);if(n)try{const e=JSON.parse(n).filter(e=>!1===e.internal);for(const t of e)await o.saveNewPreset(t),dt.find(e=>e.name===t.name)||dt.push(t);localStorage.removeItem(Tt)}catch(r){}const s=localStorage.getItem(St);if(s)try{xt=JSON.parse(s),Array.isArray(xt)||(xt=[])}catch(r){xt=[]}!function(){const e=localStorage.getItem(P);if(null!==e)try{const t=parseInt(e,10);t>=0&&t<dt.length&&(gt=t)}catch(t){}}(),function(){try{const e=localStorage.getItem(h);if(null!==e){const t=parseInt(e,10);t>=0&&t<p.length&&(y=t)}}catch(e){}}();const i=localStorage.getItem(Ct);if(i)try{Lt=JSON.parse(i),Array.isArray(Lt)||(Lt=[])}catch(r){Lt=[]}const l=new Set(dt.map(e=>e.name)),c=Lt.length;Lt=Lt.filter(e=>l.has(e)),c!==Lt.length&&wn(),0===Lt.length&&dt.length>0&&(Lt=dt.map(e=>e.name),wn()),Gn(),setTimeout(()=>{!async function(){try{const e=await fetch("./presets.json");if(!e.ok)return;const t=await e.json(),n=a.getImportedPresets();if(0===n.length)return;let o=!1;new Set(n.map(e=>e.name));for(const s of t){const e=n.find(e=>e.name===s.name);if(!e||e.message!==s.message){o=!0;break}}if(o){const e=document.getElementById("updates-status");e&&(e.textContent="üî¥ Updates available",e.style.color="#FF5722",e.style.fontWeight="bold"),window.hasPresetsUpdates=!0}}catch(e){}}()},1e3)}function vn(){const e=document.getElementById("master-prompt-indicator"),t=document.getElementById("start-screen");e&&(e.style.display=F&&!t?"block":"none")}async function bn(){const e=await o.getAllModifications(),t=new Set,n=new Map,s=[];for(const o of e)"deletion"===o.type?t.add(o.name):"modification"===o.type?n.set(o.name,o.data):"new"===o.type&&s.push(o.data);const i=await a.loadImportedPresets();let l;if(ut=i.length>0,ut)l=i;else{if(0===mt.length){const e=await fetch("./presets.json");e.ok?(m=await e.json(),mt=[...m]):(m=[],mt=[])}l=mt}return[...l.filter(e=>!t.has(e.name)).map(e=>n.has(e.name)?{...e,...n.get(e.name)}:{...e}),...s]}function wn(){try{localStorage.setItem(Ct,JSON.stringify(Lt))}catch(e){}}function Bn(){const e=dt.filter(e=>Lt.includes(e.name)).slice().sort((e,t)=>e.name.localeCompare(t.name));return{favorites:e.filter(e=>Ln(e.name)),regular:e.filter(e=>!Ln(e.name))}}function Tn(){const{favorites:e,regular:t}=Bn();return[...e.filter(e=>Lt.includes(e.name)),...t.filter(e=>Lt.includes(e.name))]}function xn(){const e=Tn(),t=dt[gt];return e.findIndex(e=>e===t)}function Sn(e){const t=Tn()[e];return dt.findIndex(e=>e===t)}function Cn(){try{const e=dt.filter(e=>!1===e.internal);localStorage.setItem(Tt,JSON.stringify(e))}catch(e){}}function Ln(e){return xt.includes(e)}function On(){const e=Tn();if(0===e.length)return 0;const t=e.filter(e=>Ln(e.name));if(t.length>0){const e=t[Math.floor(Math.random()*t.length)];return dt.findIndex(t=>t===e)}const n=e[Math.floor(Math.random()*e.length)];return dt.findIndex(e=>e===n)}function An(){Q=!Q;const e=document.getElementById("motion-toggle");if(Q)e.classList.add("active"),e.title="Motion Detection: ON",r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ üëÅÔ∏è Motion Detection":`Motion Detection mode ON ‚Ä¢ ${dt[gt].name}`,Nt("üëÅÔ∏è Motion Detection");else{e.classList.remove("active"),e.title="Motion Detection: OFF",io(),le&&(clearInterval(le),le=null);const t=document.getElementById("timer-countdown");t&&(t.style.display="none",t.classList.remove("countdown-fade-in","countdown-fade-out"));const n=document.getElementById("camera-button");n&&b.length>1&&(n.style.display="flex"),dt&&dt[gt]&&(r.textContent=re?"‚ö° NO MAGIC MODE":`Style: ${dt[gt].name}`,Nt(dt[gt].name))}}function kn(){document.getElementById("settings-submenu").style.display="none",document.getElementById("motion-submenu").style.display="flex",Ae=!0,xe=!1}function Mn(){document.getElementById("motion-submenu").style.display="none",Ae=!1,Fo()}function Nn(){document.getElementById("settings-submenu").style.display="none",document.getElementById("visible-presets-submenu").style.display="flex",fe=!1,Ot=!0,Mt=!0,xe=!1,At=0,kt="",document.getElementById("visible-presets-filter").value="",Fn(),Gn()}function Pn(){document.getElementById("visible-presets-submenu").style.display="none",Ot=!1,Mt=!1,At=0,kt="",et="";const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none"),Fo()}function Dn(){document.getElementById("settings-submenu").style.display="none",document.getElementById("preset-builder-submenu").style.display="flex",fe=!1,xe=!1,ke=!0,qn()}function Rn(){document.getElementById("preset-builder-submenu").style.display="none",ke=!1,Me=-1;const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none"),Fo()}function qn(){Me=-1,document.getElementById("preset-builder-name").value="",document.getElementById("preset-builder-category").value="",document.getElementById("preset-builder-template").value="",document.getElementById("preset-builder-prompt").value="";const e=document.getElementById("preset-builder-delete");e&&(e.style.display="none");const t=document.getElementById("preset-builder-clear");t&&(t.style.display="flex"),$n(null);const n=document.getElementById("preset-options-section-content");n&&(n.style.display="none"),document.querySelectorAll(".chip-section-content").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(e=>{e.classList.remove("expanded")})}function Hn(e=""){const t=document.getElementById("preset-options-list");if(!t)return;const n=document.createElement("div");n.className="preset-option-row";const o=t.children.length+1,s=String(o).padStart(3,"0");n.innerHTML=`\n    <span class="preset-option-id">${s}</span>\n    <input type="text" class="preset-option-text" placeholder="Option description..." value="${e}">\n    <button type="button" class="preset-option-delete" title="Remove option">√ó</button>\n  `;n.querySelector(".preset-option-delete").addEventListener("click",()=>{n.remove(),function(){const e=document.getElementById("preset-options-list");if(!e)return;const t=e.querySelectorAll(".preset-option-row");t.forEach((e,t)=>{const n=e.querySelector(".preset-option-id");n&&(n.textContent=String(t+1).padStart(3,"0"))})}()}),t.appendChild(n)}function $n(e=null){const t=document.getElementById("preset-options-list"),n=document.getElementById("preset-randomize-toggle");t&&(t.innerHTML="",e&&e.options&&e.options.length>0?(e.options.forEach(e=>{Hn(e.text)}),n&&(n.checked=e.randomizeOptions??!0)):n&&(n.checked=!0))}function Un(){const e=document.getElementById("preset-builder-template"),t=document.getElementById("preset-builder-prompt"),n=e.value;n&&void 0!==rt[n]&&(t.value=rt[n])}async function _n(){var e;const t=document.getElementById("preset-builder-name").value.trim(),n=document.getElementById("preset-builder-category").value.trim(),s=document.getElementById("preset-builder-prompt").value.trim();if(!t)return void alert("Please enter a preset name");if(!s)return void alert("Please enter a prompt");const a=n?n.split(",").map(e=>e.trim().toUpperCase()).filter(e=>e.length>0):["CUSTOM"],i=function(){const e=document.getElementById("preset-options-list");if(!e)return[];const t=e.querySelectorAll(".preset-option-row"),n=[];return t.forEach((e,t)=>{const o=e.querySelector(".preset-option-text");o&&o.value.trim()&&n.push({id:String(t+1).padStart(3,"0"),text:o.value.trim()})}),n}(),l=(null==(e=document.getElementById("preset-randomize-toggle"))?void 0:e.checked)??i.length>0;if(Me>=0){const e=dt[Me].name;if(dt[Me]={name:t.toUpperCase(),category:a,message:s,options:i,randomizeOptions:l,internal:!1},e!==t.toUpperCase()){const n=Lt.indexOf(e);n>-1&&(Lt[n]=t.toUpperCase())}}else{const e=dt.findIndex(e=>e.name.toUpperCase()===t.toUpperCase());if(-1!==e){if(!(await confirm(`A preset named "${t}" already exists. Do you want to overwrite it?`)))return;dt.splice(e,1)}const n={name:t.toUpperCase(),category:a,message:s,options:i,randomizeOptions:l,internal:!1};dt.push(n),Lt.includes(n.name)||Lt.push(n.name)}if(wn(),Me>=0){const e=dt[Me];await o.saveNewPreset(e)}else{const e=dt[dt.length-1];await o.saveNewPreset(e)}alert(Me>=0?`Preset "${t}" updated!`:`Preset "${t}" saved successfully!`),qn(),Rn(),fe&&ds()}async function jn(){if(Me<0)return void alert("No preset selected for deletion");const e=dt[Me];if(!1!==e.internal)return void alert("Cannot delete built-in presets");if(!(await confirm(`Delete preset "${e.name}"? This cannot be undone.`)))return;dt.splice(Me,1);const t=Lt.indexOf(e.name);t>-1&&(Lt.splice(t,1),wn());const n=Me===gt;if(gt>=dt.length&&(gt=dt.length-1),n){const e=dt.filter(e=>Lt.includes(e.name));e.length>0?gt=dt.findIndex(t=>t.name===e[0].name):dt.length>0&&(gt=0),qo()}const s=o.db.transaction(["presets"],"readwrite").objectStore("presets");await s.delete(`new_${e.name}`),Cn(),Gn(),alert(`Preset "${e.name}" deleted successfully!`),qn(),Rn(),fe&&ds()}function Fn(){const e=document.getElementById("visible-presets-list"),t=document.querySelector("#visible-presets-submenu .submenu-list");t&&t.scrollTop,e.innerHTML="";const n=new Set(a.getImportedPresets().map(e=>e.name)),o=dt.filter(e=>{if(e.internal)return!1;const t=n.has(e.name),o=!mt.some(t=>t.name===e.name);return t||o}).filter(e=>{if(kt){const t=kt.toLowerCase(),n=e.category&&e.category.some(e=>e.toLowerCase().includes(t));if(!(e.name.toLowerCase().includes(t)||n))return!1}return!et||e.category&&e.category.includes(et)}).sort((e,t)=>e.name.localeCompare(t.name)),s=document.createDocumentFragment();o.forEach(e=>{const t=document.createElement("div");t.className="style-item",t.dataset.presetName=e.name;const n=document.createElement("input");n.type="checkbox",n.className="master-prompt-checkbox",n.checked=Lt.includes(e.name),n.style.marginRight="3vw";const o=document.createElement("span");o.className="style-name",o.textContent=e.name,t.appendChild(n),t.appendChild(o),n.onclick=t=>{t.stopPropagation(),Vn(e.name,n.checked)},t.onclick=()=>{n.checked=!n.checked,Vn(e.name,n.checked)},s.appendChild(t)}),e.appendChild(s);const i=document.getElementById("visible-presets-count");if(i){const e=o.filter(e=>Lt.includes(e.name)).length;i.textContent=e}setTimeout(()=>{zn()},50)}function Vn(e,t){const n=Lt.indexOf(e);t&&-1===n?Lt.push(e):!t&&n>-1&&Lt.splice(n,1),wn(),Gn();const o=dt[gt];if(o&&!t&&o.name===e){const e=dt.filter(e=>Lt.includes(e.name));e.length>0&&(gt=dt.findIndex(t=>t.name===e[0].name),qo())}const s=document.querySelector("#visible-presets-submenu .submenu-list"),a=s?s.scrollTop:0;Fn(),s&&requestAnimationFrame(()=>{s.scrollTop=a});const i=document.getElementById("styles-count");if(i){const{favorites:e,regular:t}=Bn(),n=e.length+t.length;i.textContent=n}fe&&ds()}function Gn(){const e=document.getElementById("current-visible-presets-display");if(e){const t=dt.filter(e=>!e.internal).length,n=Lt.length;e.textContent=n===t?"All Visible":`${n} of ${t}`}}function zn(){if(!Ot)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(0===t.length)return;t.forEach(e=>{e.classList.remove("menu-selected")}),At=Math.max(0,Math.min(At,t.length-1));const n=t[At];if(n){n.classList.add("menu-selected"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const e=n.dataset.presetName,t=dt.find(t=>t.name===e),o=document.getElementById("visible-presets-category-hint");o&&t&&t.category&&!st?(o.innerHTML="",o.style.display="block",t.category.forEach((e,n)=>{const s=document.createElement("span");if(s.textContent=e,s.style.cursor="pointer",s.style.padding="0 2px",et===e&&(s.style.textDecoration="underline",s.style.fontWeight="bold"),s.onclick=t=>{t.stopPropagation(),et=et===e?"":e,At=0,Fn()},o.appendChild(s),n<t.category.length-1){const e=document.createElement("span");e.textContent=", ",o.appendChild(e)}})):o&&(o.style.display="none")}}function Jn(){const e=["Very Low","Low","Medium","High","Very High"],t=document.getElementById("current-motion-display");if(t){const n=Math.floor((50-ee)/10)+1,o=Math.max(1,Math.min(5,n));t.textContent=`Sensitivity: ${e[o-1]}`}}function Wn(){const e={motionThreshold:ee,motionPixelThreshold:te,motionContinuousEnabled:ne,motionCooldown:oe,motionStartDelay:ae};try{localStorage.setItem(ie,JSON.stringify(e))}catch(t){}}function Yn(){try{const e=localStorage.getItem(ie);if(e){const t=JSON.parse(e);ee=t.motionThreshold||30,te=t.motionPixelThreshold||.1,ne=void 0===t.motionContinuousEnabled||t.motionContinuousEnabled,oe=t.motionCooldown||2,ae=t.motionStartDelay||3}{const e=document.getElementById("motion-sensitivity-slider");if(e){const t=Math.floor((50-ee)/10)+1;e.value=Math.max(1,Math.min(5,t))}const t=document.getElementById("motion-continuous-enabled");t&&(t.checked=ne);const n=document.getElementById("motion-cooldown-slider");n&&(n.value=oe);const o=document.getElementById("motion-start-delay-slider"),s=document.getElementById("motion-start-delay-value");if(o&&s){const e=function(){for(let e in ce)if(ce[e].seconds===ae)return parseInt(e);return 1}();o.value=e,s.textContent=ce[e].label}Jn()}}catch(e){}}function Xn(){re=!re;const e=document.getElementById("no-magic-status");e&&(e.textContent=re?"Enabled":"Disabled",e.style.color=re?"#4CAF50":"",e.style.fontWeight=re?"600":"");try{localStorage.setItem(de,JSON.stringify(re))}catch(t){}Qn(),re?showStatus("No Magic Mode ON - Camera only",2e3):showStatus("No Magic Mode OFF - AI prompts enabled",2e3)}function Qn(){window.cameraStarted&&(re?r&&(r.textContent="‚ö° NO MAGIC MODE"):qo())}function Zn(){const e=document.getElementById("current-import-resolution-display");if(e){const t=f[E];e.textContent=t.name.split(" ")[0]}}async function Kn(){if(!Ie){!function(){if(!to){to=document.createElement("div"),to.id="loading-overlay",to.innerHTML='\n      <div class="loading-spinner"></div>\n      <div class="loading-text">Loading...</div>\n    ',to.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.7);\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      z-index: 10000;\n    ";const e=document.createElement("style");e.textContent="\n      .loading-spinner {\n        width: 40px;\n        height: 40px;\n        border: 4px solid #f3f3f3;\n        border-top: 4px solid #3498db;\n        border-radius: 50%;\n        animation: spin 1s linear infinite;\n      }\n      @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n      .loading-text {\n        color: white;\n        margin-top: 12px;\n        font-size: 16px;\n      }\n    ",document.head.appendChild(e)}document.body.appendChild(to)}();try{Ie=await t(()=>import("./tutorial-BKWlWUkC.js"),[],import.meta.url),Ie.initTutorial({showSettingsSubmenu:Fo,setIsMenuOpen:e=>{fe=e},setIsSettingsSubmenuOpen:e=>{xe=e}})}catch(e){return no(),alert("Failed to load tutorial. Please try again."),null}no()}return Ie}async function eo(){const e=await Kn();e&&(e.openTutorial(),e.isTutorialOpenState(),ve=e.isTutorialSubmenuOpenState())}let to=null;function no(){to&&to.parentNode&&to.parentNode.removeChild(to)}function oo(){document.getElementById("settings-submenu").style.display="none";const e=document.getElementById("import-resolution-submenu"),t=document.getElementById("import-resolution-list");t.innerHTML="",f.forEach((e,n)=>{const o=document.createElement("div");o.className="resolution-item",n===E&&o.classList.add("selected"),o.textContent=e.name,o.onclick=()=>{E=n,localStorage.setItem(I,E.toString()),Zn(),so()},t.appendChild(o)}),e.style.display="flex"}function so(){document.getElementById("import-resolution-submenu").style.display="none",document.getElementById("settings-submenu").style.display="flex"}function ao(){i&&l&&(K=null,se=!1,Z=setInterval(()=>{if(!Q)return;if(se)return;if(!ne&&"block"===c.style.display)return;(function(){if(!i||!l)return!1;const e=l.getContext("2d"),t=320,n=240;l.width=t,l.height=n,e.drawImage(i,0,0,t,n);const o=e.getImageData(0,0,t,n);if(!K)return K=o,!1;let s=0;const a=t*n;for(let i=0;i<o.data.length;i+=4){(Math.abs(o.data[i]-K.data[i])+Math.abs(o.data[i+1]-K.data[i+1])+Math.abs(o.data[i+2]-K.data[i+2]))/3>ee&&s++}K=o;return s/a>te})()&&(Mo(),se=!0,setTimeout(()=>{if(se=!1,K=null,"block"===c.style.display&&(c.style.display="none",i.style.display="block"),!ne){io(),Q=!1;const e=document.getElementById("motion-toggle");e.classList.remove("active"),e.title="Motion Detection: OFF",showStatus("Motion capture complete - Press eye button to reactivate",3e3),dt&&dt[gt]&&Nt(dt[gt].name)}},1e3*oe))},500))}function io(){Z&&(clearInterval(Z),Z=null),K=null}function lo(){X=!X;const e=document.getElementById("random-toggle");X?(e.classList.add("random-active"),r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ üé≤ Random Mode":`Random mode ON ‚Ä¢ ${dt[gt].name}`,Nt("üé≤ Random Mode")):(e.classList.remove("random-active"),qo(),dt&&dt[gt]&&Nt(dt[gt].name)),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"random_mode_toggled",enabled:X,timestamp:Date.now()}))}function co(){try{localStorage.setItem(vt,JSON.stringify(ht))}catch(e){}}function ro(){bt&&(yt?(bt.className="connection-status online",bt.querySelector("#connection-text").textContent="Online"):(bt.className="connection-status offline",bt.querySelector("#connection-text").textContent="Offline")),mo()}function mo(){if(wt){const e=ht.length;wt.querySelector("#queue-count").textContent=e,wt.style.display=e>0?"block":"none"}if(Bt){const e=ht.length;Bt.querySelector("#sync-count").textContent=e,Bt.style.display=e>0&&yt?"block":"none"}}function uo(){const e=p[y];if(0===b.length)return{video:{facingMode:"environment",width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};const t={video:{deviceId:{exact:b[v].deviceId},width:{exact:e.width},height:{exact:e.height},frameRate:{ideal:30,max:30}}};return yo()&&(t.video.advanced=[{zoom:1}]),t}async function go(e){if(e!==y&&u){y=e,function(e){try{localStorage.setItem(h,e.toString())}catch(t){}}(e);try{r.textContent="Changing resolution...",u&&u.getTracks().forEach(e=>e.stop());const e=uo();u=await navigator.mediaDevices.getUserMedia(e),i.srcObject=u,g=u.getVideoTracks()[0],await new Promise(e=>{i.onloadedmetadata=async()=>{try{await i.play(),ho(),await Eo(B),setTimeout(e,100)}catch(t){e()}}}),qo(),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"resolution_changed",resolution:p[y].name,timestamp:Date.now()}))}catch(t){r.textContent="Resolution change failed"}}}function po(){if(0===b.length)return"Default Camera";const e=b[v];let t=e.label;return t&&""!==t?(t=t.replace(/\([^)]*\)/g,"").trim(),t.toLowerCase().includes("front")?t="Front Camera":t.toLowerCase().includes("back")||t.toLowerCase().includes("rear")?t="Back Camera":t.length>20&&(t=t.substring(0,17)+"...")):t=e.deviceId?`Camera ${v+1}`:"Unknown Camera",t}function yo(){if(0===b.length)return!1;const e=b[v];if(!e)return!1;const t=e.label.toLowerCase();return"user"===e.facingMode||"environment"!==e.facingMode&&(!!(t.includes("front")||t.includes("user")||t.includes("selfie")||t.includes("face"))||!(t.includes("back")||t.includes("rear")||t.includes("environment"))&&(2===b.length?1===v:v>0))}function ho(){try{yo()?(i.style.transform="translateZ(0)",i.style.webkitTransform="translateZ(0)"):(i.style.transform="scaleX(-1) translateZ(0)",i.style.webkitTransform="scaleX(-1) translateZ(0)")}catch(e){}}function fo(){if(!g)return{min:1,max:5,step:.1};const e=g.getCapabilities();return e&&e.zoom?{min:Math.min(e.zoom.min||1,1),max:Math.max(e.zoom.max||5,5),step:e.zoom.step||.1}:{min:1,max:5,step:.1}}async function Eo(e){if(g)try{if(function(){if(!g)return!1;const e=g.getCapabilities();return e&&"zoom"in e}()){const t=fo(),n=Math.max(t.min,Math.min(e,t.max)),o={advanced:[{zoom:n}]},s=g.getCapabilities();s&&s.focusMode&&s.focusMode.includes("continuous")&&(o.advanced[0].focusMode="continuous"),await g.applyConstraints(o),B=n,yo()?(i.style.transform="translateZ(0)",i.style.webkitTransform="translateZ(0)"):(i.style.transform="scaleX(-1) translateZ(0)",i.style.webkitTransform="scaleX(-1) translateZ(0)")}else{const t=Math.max(1,Math.min(e,5));B=t,yo()?(i.style.transform=`scale(${t})`,i.style.webkitTransform=`scale(${t})`):(i.style.transform=`scaleX(-1) scale(${t})`,i.style.webkitTransform=`scaleX(-1) scale(${t})`)}}catch(t){const n=Math.max(1,Math.min(e,5));B=n,yo()?(i.style.transform=`scale(${n})`,i.style.webkitTransform=`scale(${n})`):(i.style.transform=`scaleX(-1) scale(${n})`,i.style.webkitTransform=`scaleX(-1) scale(${n})`)}}async function Io(){if(!(w||b.length<=1)){w=!0;try{r.textContent="Switching camera...",u&&u.getTracks().forEach(e=>e.stop()),v=(v+1)%b.length;const e=uo();u=await navigator.mediaDevices.getUserMedia(e),i.srcObject=u,g=u.getVideoTracks()[0],await new Promise(e=>{i.onloadedmetadata=async()=>{try{await i.play(),ho(),await Eo(B),setTimeout(e,100)}catch(t){e()}}}),qo(),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"camera_switched",cameraIndex:v,cameraLabel:po(),timestamp:Date.now()}))}catch(e){r.textContent="Camera switch failed",v=(v-1+b.length)%b.length}finally{w=!1}}}function vo(e,t){try{localStorage.setItem(M,JSON.stringify({count:e,speed:t}))}catch(n){}}function bo(){C=!C;const e=document.getElementById("burst-toggle");C?(e.classList.add("burst-active"),r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${L} photos) ‚Ä¢ ${dt[gt].name}`,Nt("üì∏ Burst Mode")):(e.classList.remove("burst-active"),qo(),dt&&dt[gt]&&Nt(dt[gt].name)),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_mode_toggled",enabled:C,count:L,timestamp:Date.now()}))}function wo(){D=!D;const e=document.getElementById("timer-toggle");D?(e.classList.add("timer-active"),r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ ‚è±Ô∏è Timer Mode":`Timer mode ON (${q}s delay) ‚Ä¢ ${dt[gt].name}`,Nt("‚è±Ô∏è Timer Mode")):(e.classList.remove("timer-active"),R&&(clearInterval(R),R=null,document.getElementById("timer-countdown").style.display="none"),qo(),dt&&dt[gt]&&Nt(dt[gt].name)),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"timer_mode_toggled",enabled:D,delay:q,timestamp:Date.now()}))}function Bo(e){let t=q;const n=document.getElementById("timer-countdown"),o=document.getElementById("timer-countdown-text");o.textContent=t,n.style.display="flex",n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),r.textContent=`Timer: ${t}s...`,R=setInterval(()=>{t--,t>0?(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{o.textContent=t,n.classList.remove("countdown-fade-out"),n.classList.add("countdown-fade-in"),r.textContent=`Timer: ${t}s...`},500)):(n.classList.remove("countdown-fade-in"),n.classList.add("countdown-fade-out"),setTimeout(()=>{n.style.display="none",n.classList.remove("countdown-fade-out"),clearInterval(R),R=null,e(),H&&D&&(setTimeout(()=>{if("block"===c.style.display){c.style.display="none",i.style.display="block";const e=document.getElementById("camera-button");e&&b.length>1&&(e.style.display="flex")}},500),setTimeout(()=>{D&&Bo(e)},1e3*U))},500))},1e3)}function To(){R&&(clearInterval(R),R=null,document.getElementById("timer-countdown").style.display="none",qo())}function xo(){try{localStorage.setItem(N,JSON.stringify({delay:q,repeat:H,repeatInterval:U}))}catch(e){}}function So(){const e=document.getElementById("current-timer-display");if(e){const t=H?`Repeat (${_[function(){for(const[e,t]of Object.entries(_))if(t.seconds===U)return parseInt(e);return 1}()].label})`:"No Repeat";e.textContent=`${q}s, ${t}`}}async function Co(){if(u&&!A&&"block"!==c.style.display){A=!0,r.textContent=`Burst mode: Taking ${L} photos...`;for(let e=0;e<L;e++)r.textContent=`Burst ${e+1}/${L}...`,Lo(e+1),e<L-1&&await new Promise(e=>setTimeout(e,O));A=!1,r.textContent=`Burst complete! ${L} photos saved.`,yt&&!ft?setTimeout(()=>{No()},500):yt||(r.textContent=`Burst complete! ${L} photos queued (offline).`),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"burst_complete",count:L,timestamp:Date.now()})),setTimeout(()=>{C?r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${L} photos) ‚Ä¢ ${dt[gt].name}`:qo()},2e3)}}function Lo(e){if(!u)return;X&&(gt=On()),l.width===i.videoWidth&&l.height===i.videoHeight||(l.width=i.videoWidth,l.height=i.videoHeight);const t=l.getContext("2d",{willReadFrequently:!1,alpha:!1});t.clearRect(0,0,l.width,l.height);const n=l.width/B,o=l.height/B,s=(l.width-n)/2,a=(l.height-o)/2;if(yo())t.drawImage(i,s,a,n,o,0,0,l.width,l.height);else{t.save(),t.scale(-1,1),t.drawImage(i,s,a,n,o,-l.width,0,l.width,l.height),t.restore();const e=document.createElement("canvas");e.width=l.width,e.height=l.height;const c=e.getContext("2d");c.scale(-1,1),c.drawImage(l,-l.width,0),t.clearRect(0,0,l.width,l.height),t.drawImage(e,0,0)}const c=y>=2?.7:.8,r=l.toDataURL("image/jpeg",c),d=dt[gt];Ht(r);const m={id:Date.now().toString()+"-"+e,imageBase64:r,preset:d,timestamp:Date.now()};ht.push(m),co(),mo()}async function Oo(){try{i=document.getElementById("video"),l=document.getElementById("canvas"),c=document.getElementById("captured-image"),r=document.getElementById("status"),d=document.getElementById("reset-button");const e=document.getElementById("start-screen");if(e){const t=e.querySelector(".start-text");t&&(t.textContent="Requesting camera access...");const n=document.getElementById("start-button");n&&(n.disabled=!0)}if(await async function(){try{const e=await navigator.mediaDevices.enumerateDevices();return b=e.filter(e=>"videoinput"===e.kind),b}catch(e){return[]}}(),b.length>1){const e=b.findIndex(e=>{const t=e.label.toLowerCase();return t.includes("back")||t.includes("rear")||t.includes("environment")});v=-1!==e?e:b.length-1}else v=0;const t=uo();u=await navigator.mediaDevices.getUserMedia(t),i.srcObject=u,g=u.getVideoTracks()[0],function(){try{const e=localStorage.getItem(vt);e&&(ht=JSON.parse(e))}catch(e){ht=[]}}(),window.addEventListener("online",()=>{yt=!0,ro(),ht.length>0&&!ft&&setTimeout(()=>{r.textContent=`Connection restored! Syncing ${ht.length} photos...`,No()},1e3)}),window.addEventListener("offline",()=>{yt=!1,ro(),ft&&(r.textContent="Connection lost during sync")}),ro(),await new Promise(e=>{i.onloadedmetadata=async()=>{try{await i.play(),ho(),Eo(1),setTimeout(e,100)}catch(t){e()}}}),document.getElementById("start-screen").remove(),document.getElementById("camera-container").style.display="flex",r.style.display="block";const n=document.getElementById("camera-button");b.length>1&&(n.style.display="flex");const o=document.getElementById("menu-button");o&&(o.style.display="flex");const s=document.getElementById("mode-carousel");s&&(s.style.display="block");const a=document.getElementById("gallery-button");a&&(a.style.display="flex"),qo();const m=document.getElementById("connection-status");if(m&&yt&&(m.style.display="block",setTimeout(()=>{m.style.display="none"},3e3)),window.hasPresetsUpdates){const e=document.getElementById("updates-indicator");e&&(e.style.display="block",setTimeout(()=>{e.style.display="none"},3e3))}vn(),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_ready",availableCameras:b.length,currentCamera:po(),timestamp:Date.now()}))}catch(e){r.textContent="Camera access denied";const t=document.getElementById("start-button");t&&(t.disabled=!1);const n=document.getElementById("start-screen");n&&(n.style.display="block"),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({status:"camera_error",error:e.message,timestamp:Date.now()}))}}function Ao(){u&&i&&(u.getTracks().forEach(e=>{e.stop()}),i.style.display="none",i.srcObject=null)}async function ko(){if(i)try{const e=uo();u=await navigator.mediaDevices.getUserMedia(e),i.srcObject=u,g=u.getVideoTracks()[0],await new Promise(e=>{i.onloadedmetadata=async()=>{try{await i.play(),ho(),await Eo(B),setTimeout(e,100)}catch(t){e()}}}),i.style.display="block"}catch(e){r.textContent="Camera resume failed"}}function Mo(){if(!u)return;X&&(gt=On(),Nt(dt[gt].name)),l.width===i.videoWidth&&l.height===i.videoHeight||(l.width=i.videoWidth,l.height=i.videoHeight);const e=l.getContext("2d",{willReadFrequently:!1,alpha:!1,desynchronized:!0});e.clearRect(0,0,l.width,l.height);const t=l.width/B,n=l.height/B,o=(l.width-t)/2,s=(l.height-n)/2;if(yo())e.drawImage(i,o,s,t,n,0,0,l.width,l.height);else{e.save(),e.scale(-1,1),e.drawImage(i,o,s,t,n,-l.width,0,l.width,l.height),e.restore();const a=document.createElement("canvas");a.width=l.width,a.height=l.height;const c=a.getContext("2d");c.scale(-1,1),c.drawImage(l,-l.width,0),e.clearRect(0,0,l.width,l.height),e.drawImage(a,0,0)}const a=y>=2?.7:.8,m=l.toDataURL("image/jpeg",a);c.src=m,c.style.display="block",c.style.transform="none",i.style.display="none",Ls(),d.style.display=Q||D&&H?"none":"block";const g=document.getElementById("camera-button");g&&(g.style.display="none");const p=document.getElementById("resolution-button");p&&(p.style.display="none"),Ht(m);const h=dt[gt],f={id:Date.now().toString(),imageBase64:m,preset:h,timestamp:Date.now()};if(ht.push(f),co(),mo(),yt){const e=re?"Photo saved!":"Photo saved! Uploading...";r.textContent=e,ft||No()}else r.textContent=`Photo queued for sync (${ht.length} in queue)`;"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"photo_captured",queued:!0,queueLength:ht.length,timestamp:Date.now()}))}async function No(){if(0===ht.length||ft)return;if(!yt)return void(r.textContent="Cannot sync - offline");ft=!0,Bt.disabled=!0,Bt.classList.add("syncing");const e=ht.length;let t=0;for(;ht.length>0&&yt;){const o=ht[0];try{if(r.textContent=`Syncing ${t+1}/${e}...`,"undefined"==typeof PluginMessageHandler||re||PluginMessageHandler.postMessage(JSON.stringify({message:cs(o.preset.message,o.preset.name,o.preset),pluginId:"com.r1.pixelart",imageBase64:o.imageBase64})),await new Promise(e=>setTimeout(e,3e3)),!yt)break;ht.shift(),t++,co(),mo(),await new Promise(e=>setTimeout(e,3e3))}catch(n){r.textContent="Sync error - will retry later";break}}if(ft=!1,Bt.disabled=!1,Bt.classList.remove("syncing"),0===ht.length){const e=re?`All ${t} photos saved!`:`All ${t} photos synced successfully!`;r.textContent=e,setTimeout(()=>{qo()},2e3)}else r.textContent=yt?`Synced ${t}. ${ht.length} remaining.`:`Connection lost. ${ht.length} photos queued.`;"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"sync_complete",synced:t,remaining:ht.length,timestamp:Date.now()}))}function Po(){const e=document.getElementById("queue-manager"),t=document.getElementById("queue-list");t.innerHTML="",0===ht.length?t.innerHTML='\n      <div class="queue-empty">\n        <h4>No Photos in Queue</h4>\n        <p>Take photos while offline and they\'ll appear here for syncing.</p>\n      </div>\n    ':ht.forEach((e,n)=>{const o=document.createElement("div");o.className="queue-item",o.innerHTML=`\n        <div class="queue-item-header">\n          <span class="queue-item-style">${e.preset.name}</span>\n          <span class="queue-item-time">${new Date(e.timestamp).toLocaleString()}</span>\n        </div>\n        <img src="${e.imageBase64}" class="queue-item-preview" alt="Queued photo">\n        <div class="queue-item-actions">\n          <button onclick="removeFromQueue(${n})" class="delete-button">Remove</button>\n          <button onclick="previewQueueItem(${n})" class="secondary">Preview</button>\n        </div>\n      `,t.appendChild(o)}),e.style.display="flex"}function Do(){document.getElementById("queue-manager").style.display="none"}async function Ro(){await confirm("Clear all photos from the queue? This cannot be undone.")&&(ht=[],co(),mo(),Po())}function qo(){gt=Math.max(0,Math.min(gt,dt.length-1));const e=dt[gt];if(g)try{const e={};g.applyConstraints(e)}catch(t){}r&&(r.textContent=re?"‚ö° NO MAGIC MODE":`Style: ${e.name}`),Nt(e.name),localStorage.setItem(P,gt.toString()),fe&&En()}function Ho(){c.style.display="none",Q&&ne||(io(),Q&&ao()),c.style.transform="none",i.style.display="block",d.style.display="none";const e=document.getElementById("camera-button");e&&b.length>1&&(e.style.display="flex");const t=document.getElementById("resolution-button");t&&(t.style.display="flex"),setTimeout(()=>{Eo(B)},50),qo(),Cs()}function $o(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.sqrt(n*n+o*o)}function Uo(){const e=document.getElementById("video");e.addEventListener("touchstart",e=>{2===e.touches.length&&(e.preventDefault(),T=!0,x=$o(e.touches[0],e.touches[1]),S=B)},{passive:!1});let t=null;e.addEventListener("touchmove",e=>{if(T&&2===e.touches.length){e.preventDefault();const n=$o(e.touches[0],e.touches[1]),o=S*(n/x),s=fo(),a=Math.max(s.min,Math.min(o,s.max));t||(Eo(a),t=setTimeout(()=>{t=null},50))}},{passive:!1}),e.addEventListener("touchend",e=>{e.touches.length<2&&(T&&async function(){if(g)try{const e=g.getCapabilities();e&&e.focusMode&&(e.focusMode.includes("single-shot")?(await g.applyConstraints({advanced:[{focusMode:"single-shot",zoom:B}]}),setTimeout(async()=>{try{await g.applyConstraints({advanced:[{focusMode:"continuous",zoom:B}]})}catch(e){}},500)):e.focusMode.includes("manual")&&await g.applyConstraints({advanced:[{focusMode:"manual",zoom:B}]}))}catch(e){}}(),T=!1)}),e.addEventListener("touchcancel",()=>{T=!1})}function _o(){const e=document.getElementById("unified-menu");c&&"block"===c.style.display&&Ho(),ds();const t=document.getElementById("styles-count");if(t){const{favorites:e,regular:n}=Bn(),o=e.length+n.length;t.textContent=o}Yo(),Xo(),is(),So(),fe=!0,Ee=!0,Ao(),To(),e.style.display="flex"}async function jo(){fe=!1,Ee=!1,he=0,Qe="",tt="",document.getElementById("style-filter").value="";const e=document.getElementById("menu-category-hint");if(e&&(e.style.display="none"),document.getElementById("unified-menu").style.display="none",await ko(),re)r&&(r.textContent="‚ö° NO MAGIC MODE"),Nt("‚ö° NO MAGIC MODE");else if(D||C||Q||X){let e="";D?e="‚è±Ô∏è Timer Mode":C?e="üì∏ Burst Mode":Q?e="üëÅÔ∏è Motion Detection":X&&(e="üé≤ Random Mode"),r&&(r.textContent=`${e} ‚Ä¢ ${dt[gt]?dt[gt].name:""}`),Nt(e)}else qo()}function Fo(){const e=document.getElementById("settings-submenu"),t=document.getElementById("unified-menu");Yo(),Xo(),So(),is(),t.style.display="none",Ao(),e.style.display="flex",fe=!1,xe=!0,Be=0,setTimeout(()=>{Zt()},50)}function Vo(){if(ge)return ge=!1,document.getElementById("settings-submenu").style.display="none",xe=!1,document.getElementById("unified-menu").style.display="none",fe=!1,Ee=!1,void Ut().then(()=>{zt(pe)});document.getElementById("settings-submenu").style.display="none",xe=!1,Be=0,_o()}function Go(){const e=document.getElementById("timer-settings-submenu"),t=document.getElementById("settings-submenu"),n=document.getElementById("timer-delay-slider"),o=document.getElementById("timer-delay-value"),s=document.getElementById("timer-repeat-enabled");if(n&&o){const e=$.indexOf(q);n.value=-1!==e?e+1:3,o.textContent=q}s&&(s.checked=H);const a=document.getElementById("timer-repeat-interval-input"),i=document.getElementById("timer-repeat-interval-unit");a&&i&&(U>=3600&&U%3600==0?(a.value=U/3600,i.value="3600"):U>=60&&U%60==0?(a.value=U/60,i.value="60"):(a.value=U,i.value="1")),t.style.display="none",Ao(),e.style.display="flex",Le=!0,xe=!1}function zo(){document.getElementById("timer-settings-submenu").style.display="none",Le=!1,Fo()}function Jo(){const e=document.querySelector(".styles-menu-scroll-container");e&&(e.scrollTo({top:0,behavior:"smooth"}),he=0,En())}function Wo(){const e=document.querySelector(".styles-menu-scroll-container");if(e){e.scrollTo({top:e.scrollHeight,behavior:"smooth"});const t=document.getElementById("menu-styles-list");if(t){const e=t.querySelectorAll(".style-item");e.length>0&&(he=e.length-1,En())}}}function Yo(){const e=document.getElementById("current-resolution-display");if(e){const t=p[y];e.textContent=`${t.width}x${t.height}`}}function Xo(){const e=document.getElementById("current-burst-display");if(e){let t="Medium";for(const[e,n]of Object.entries(k))if(n.delay===O){t=n.label;break}e.textContent=`${L} photos, ${t}`}}function Qo(){document.getElementById("settings-submenu").style.display="none",Ao();const e=document.getElementById("resolution-submenu"),t=document.getElementById("resolution-list");t.innerHTML="",p.forEach((e,n)=>{const o=document.createElement("div");o.className="resolution-item",n===y&&o.classList.add("active");const s=document.createElement("span");s.className="resolution-name",s.textContent=e.name,o.appendChild(s),o.onclick=()=>{go(n),Zo()},t.appendChild(o)}),e.style.display="flex",Se=!0,xe=!1,Te=0,setTimeout(()=>{Kt(e.querySelectorAll(".resolution-item"))},100)}async function Zo(){document.getElementById("resolution-submenu").style.display="none",Se=!1,Te=0,Fo()}function Ko(){document.getElementById("settings-submenu").style.display="none",Ao();const e=document.getElementById("burst-submenu"),t=document.getElementById("burst-count-slider"),n=document.getElementById("burst-speed-slider"),o=document.getElementById("burst-count-value"),s=document.getElementById("burst-speed-value");if(t&&o&&(t.value=L,o.textContent=L),n&&s){let e=2;for(const[t,n]of Object.entries(k))if(n.delay===O){e=parseInt(t);break}n.value=e,s.textContent=k[e].label}e.style.display="flex",Ce=!0,xe=!1}async function es(){document.getElementById("burst-submenu").style.display="none",Ce=!1,Fo()}function ts(){document.getElementById("settings-submenu").style.display="none",Ao();const e=document.getElementById("master-prompt-submenu"),t=document.getElementById("master-prompt-enabled"),n=document.getElementById("master-prompt-text"),o=document.getElementById("master-prompt-char-count");t&&(t.checked=F),n&&(n.value=j,n.disabled=!F,o&&(o.textContent=j.length)),e.style.display="flex",Oe=!0,xe=!1}async function ns(){if(ge)return ge=!1,document.getElementById("master-prompt-submenu").style.display="none",Oe=!1,document.getElementById("settings-submenu").style.display="none",xe=!1,document.getElementById("unified-menu").style.display="none",fe=!1,Ee=!1,await Ut(),void zt(pe);document.getElementById("master-prompt-submenu").style.display="none",Oe=!1,Fo()}function os(){document.getElementById("settings-submenu").style.display="none",Ao();document.getElementById("aspect-ratio-submenu").style.display="flex",xe=!1}async function ss(){document.getElementById("aspect-ratio-submenu").style.display="none",Fo()}function as(){const e=document.getElementById("current-aspect-ratio-display");e&&(e.textContent="none"===J?"None":J)}function is(){const e=document.getElementById("current-master-prompt-display");if(e)if(F&&j.trim()){const t=j.substring(0,20);e.textContent=`Enabled: ${t}${j.length>20?"...":""}`}else e.textContent=F?"Enabled (empty)":"Disabled"}function ls(){try{localStorage.setItem(V,j),localStorage.setItem(G,F.toString()),localStorage.setItem(z,J)}catch(e){}}function cs(e,t="",n=null){let o=e;if(F&&j.trim()&&(o=`${e} ${j}`),n&&n.options&&n.options.length>0)o=function(e,t,n,o){let s=null;if(n){s=t[Math.floor(Math.random()*t.length)]}else s=window.selectedPresetOption||t[0];if(s)return rs(o,s.text),e+"\n\n"+s.text;return e}(o,n.options,n.randomizeOptions,t);else{if(/RANDOM|SELECT|SELECTION|CHOOSE|modulo|LAST DIGIT|LAST TWO DIGITS|LAST THREE DIGITS/i.test(e)){const e=Date.now();o=function(e,t,n,o,s){const a=/‚Ä¢\s*If\s+(?:the\s+)?(?:LAST\s+DIGIT|RANDOM\s+SEED)(?:\s+of\s+the\s+RANDOM\s+SEED)?(?:\s+ends\s+in)?[^\n]*?(?:is\s+)?(?:an?\s+)?(EVEN|ODD)(?:\s+number)?[^\n]*?:\s*(?:SELECT\s+)?(.+?)(?=\n‚Ä¢|\n\n|$)/gi;e=e.replace(a,(e,n,o)=>{const a=t%2==0;if("EVEN"===n.toUpperCase()&&a||"ODD"===n.toUpperCase()&&!a){const e=o.trim();return rs(s,e),""}return""}),e=e.replace(/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option\s+[AB]:|\n[A-Z][A-Z\s]+(?:\([A-Z]+\))?:|\n\n|$)/gi,(e,t,n)=>"");const i=/If\s+Option\s+([AB]):\s*\n([\s\S]*?)(?=\nIf\s+Option|$)/gi;let l=null;e.replace(i,(e,t,n)=>(l||(l=n.trim()),e)),l&&(rs(s,l),e=`SELECTED OPTION: ${l}\n(Automatically selected using random seed)`);const c=/(?:select|choose|pick)?(?:\s+exactly\s+one)?[^\n]*?(?:use|using|with|via|by)\s+(?:the\s+)?(?:last\s+(digit|two\s+digits|three\s+digits)|random\s+seed)(?:\s+of\s+the\s+random\s+seed)?[^\n]*?\s+modulo\s+(\d+)[^\n]*?:\s*\n((?:\s*-\s*\d+:.*(?:\n|$))*)/gi;return e=e.replace(c,(e,a,i,l)=>{let c;return c=a?a.toLowerCase().includes("three")?"THREE DIGITS":a.toLowerCase().includes("two")?"TWO DIGITS":"DIGIT":"TWO DIGITS",function(e,t,n,o,s,a,i,l){const c=[],r=/^\s*[-‚Äì]\s*(\d+):\s*(.+?)$/gm;let d,m;for(;null!==(d=r.exec(n));){const e=parseInt(d[1]),t=d[2].trim();c.push({number:e,option:t})}if(0===c.length)return l;"DIGIT"===e?m=o:"TWO DIGITS"===e?m=s:"THREE DIGITS"===e&&(m=a);const u=parseInt(t),g=m%u;const p=c.find(e=>e.number===g);if(p)return rs(i,p.option),`SELECTED OPTION: ${p.option}\n(Automatically selected using random seed)`;return l}(c,i,l,t,n,o,s,e)}),e=(e=(e=(e=(e=e.replace(/‚Ä¢\s*If\s+none\s+is\s+specified[^\n]*\n/gi,"")).replace(/‚Ä¢\s*If\s+no\s+\w+\s+is\s+specified[^\n]*\n/gi,"")).replace(/‚Ä¢\s*Otherwise\s+SELECT[^\n]*\n/gi,"")).replace(/^\s*[A-Z][A-Z\s]+(?:\([A-Z]+\))?:\s*$/gm,"")).replace(/\n{3,}/g,"\n\n")}(o,e%10,e%100,e%1e3,t)}}return"1:1"===J?o+=" Use a square aspect ratio.":"16:9"===J&&(o+=" Use a square aspect ratio, but pad the image with black bars at top and bottom to simulate a 16:9 aspect ratio."),o}function rs(e,t){if(!e||!t)return;const n=function(e){if(!e)return[];if(!Y[e]){const e=localStorage.getItem(W);if(e)try{Y=JSON.parse(e)}catch(t){Y={}}}return Y[e]||[]}(e);n.unshift(t),n.length>5&&n.splice(5),Y[e]=n,localStorage.setItem(W,JSON.stringify(Y))}function ds(e=!1){const t=document.getElementById("menu-styles-list");t.innerHTML="",t.replaceWith(t.cloneNode(!1));const n=document.getElementById("menu-styles-list"),o=document.createDocumentFragment(),{favorites:s,regular:a}=Bn(),i=s.filter(e=>{if(Qe){const t=Qe.toLowerCase(),n=e.category&&e.category.some(e=>e.toLowerCase().includes(t));if(!(e.name.toLowerCase().includes(t)||e.message.toLowerCase().includes(t)||n))return!1}return!tt||e.category&&e.category.includes(tt)}),l=a.filter(e=>{if(Qe){const t=Qe.toLowerCase(),n=e.category&&e.category.some(e=>e.toLowerCase().includes(t));if(!(e.name.toLowerCase().includes(t)||e.message.toLowerCase().includes(t)||n))return!1}return!tt||e.category&&e.category.includes(tt)});if(i.length>0){const e=document.createElement("h3");e.className="menu-section-header",e.textContent="‚òÖ Favorites",o.appendChild(e),i.forEach(e=>{const t=ms(e);o.appendChild(t)})}if(l.length>0){const e=document.createElement("h3");e.className="menu-section-header",e.textContent=Qe?"Search Results":"All Styles",o.appendChild(e),l.forEach(e=>{const t=ms(e);o.appendChild(t)})}if(0===l.length&&0===i.length&&Qe){const e=document.createElement("div");e.className="menu-empty",e.textContent="No styles found",o.appendChild(e)}n.appendChild(o),n.addEventListener("click",us);const c=document.getElementById("styles-count");if(c){const{favorites:e,regular:t}=Bn(),n=e.length+t.length;c.textContent=n}e||(he=0,En())}function ms(e){const t=dt.findIndex(t=>t===e),n=document.createElement("div");n.className="style-item",n.dataset.index=t,t===gt&&n.classList.add("active");const o=document.createElement("button");o.className="style-favorite",o.textContent=Ln(e.name)?"‚≠ê":"‚òÜ",o.dataset.action="favorite",o.dataset.styleName=e.name;const s=document.createElement("span");s.className="style-name",s.textContent=e.name;const a=document.createElement("button");a.className="style-edit";const i=!1===e.internal;return a.textContent=i?"Builder":"Edit",a.dataset.action=i?"builder":"edit",a.dataset.index=t,n.appendChild(o),n.appendChild(s),n.appendChild(a),n}function us(e){const t=e.target;if("favorite"===t.dataset.action){e.stopPropagation();return void function(e){const t=xt.indexOf(e);t>-1?xt.splice(t,1):xt.push(e),localStorage.setItem(St,JSON.stringify(xt));const n=document.querySelector(".styles-menu-scroll-container"),o=n?n.scrollTop:0;ds(),n&&(n.scrollTop=o)}(t.dataset.styleName)}if("edit"===t.dataset.action){e.stopPropagation();return void function(e){const t=dt[e];Dn(),Me=e,setTimeout(()=>{const e=document.getElementById("preset-builder-name"),n=document.getElementById("preset-builder-category"),o=document.getElementById("preset-builder-prompt"),s=document.getElementById("preset-builder-template"),a=document.getElementById("preset-builder-delete"),i=document.getElementById("preset-builder-clear");if(e&&(e.value=t.name),n&&(n.value=t.category?t.category.join(", "):""),o&&(o.value=t.message),s&&(s.value=""),a&&(a.style.display="flex"),i&&(i.style.display="none"),$n(t),t.options&&t.options.length>0){const e=document.getElementById("preset-options-section-content"),t=document.getElementById("preset-options-arrow");e&&(e.style.display="block"),t&&t.classList.add("expanded")}},100)}(parseInt(t.dataset.index))}const n=t.closest(".style-item");if(n){const e=parseInt(n.dataset.index);isNaN(e)||(gt=e,qo(),jo())}}window.addEventListener("sideClick",()=>{if(xe){const e=document.getElementById("settings-submenu").querySelectorAll(".menu-section-button");return void(e.length>0&&Be<e.length&&e[Be].click())}if(Ot)return void function(){if(!Ot||!Mt)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(0===t.length||At>=t.length)return;const n=t[At];n&&n.click()}();if(ve&&Ie)return void Ie.selectCurrentTutorialItem();if(Se){const e=document.getElementById("resolution-submenu").querySelectorAll(".resolution-item");return void(e.length>0&&Te<e.length&&e[Te].click())}if(be)return void function(){if(!be)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");if(0===t.length||we>=t.length)return;const n=t[we];n&&n.click()}();if(fe&&Ee)return void function(){if(!fe||!Ee)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");if(0===t.length||he>=t.length)return;const n=t[he];if(n&&n.querySelector(".style-name")){const e=Tn()[he];if(e){const t=dt.findIndex(t=>t===e);-1!==t&&(gt=t,qo(),jo())}}}();const e=document.getElementById("start-screen"),t=document.getElementById("start-button");if(e&&"none"!==e.style.display)setTimeout(()=>{t.click()},100);else if(c&&"block"===c.style.display)Ho();else{if(Q){if(ae>0){let e=ae;const t=document.getElementById("timer-countdown"),n=document.getElementById("timer-countdown-text");n.textContent=e,t.style.display="flex",t.classList.remove("countdown-fade-out"),t.classList.add("countdown-fade-in"),r.textContent=`Motion Detection starting in ${e}s...`,le=setInterval(()=>{e--,e>0?(t.classList.remove("countdown-fade-in"),t.classList.add("countdown-fade-out"),setTimeout(()=>{n.textContent=e,t.classList.remove("countdown-fade-out"),t.classList.add("countdown-fade-in"),r.textContent=`Motion Detection starting in ${e}s...`},500)):(t.classList.remove("countdown-fade-in"),t.classList.add("countdown-fade-out"),setTimeout(()=>{t.style.display="none",t.classList.remove("countdown-fade-out"),clearInterval(le),Q&&i&&i.readyState>=2&&(ao(),showStatus("Motion Detection active - Move in front of camera",3e3))},500))},1e3)}else ao(),showStatus("Motion Detection ON - Move in front of camera",3e3);return}D?Bo(C?()=>Co():()=>Mo()):C?Co():Mo()}}),window.addEventListener("scrollUp",()=>{var e,t,n,o;if("flex"===document.getElementById("style-editor").style.display)return void nn();if(be)return void function(){if(!be)return;const e=document.getElementById("preset-list");if(!e)return;0!==e.querySelectorAll(".preset-item").length&&(we=Math.max(0,we-1),Qt())}();if(a.isImportModalOpen)return void a.scrollImportUp();if(ve&&Ie)return void Ie.scrollTutorialUp();if(ke)return void en();if(Ot)return void function(){if(!Ot||!Mt)return;const e=document.getElementById("visible-presets-list");if(!e)return;0!==e.querySelectorAll(".style-item").length&&(At=Math.max(0,At-1),zn())}();if(fe&&Ee)return void function(){if(!fe||!Ee)return;const e=document.getElementById("menu-styles-list");if(!e)return;0!==e.querySelectorAll(".style-item").length&&(he=Math.max(0,he-1),En())}();if(Ae)return void function(){const e=document.getElementById("motion-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if(Oe)return void function(){const e=document.getElementById("master-prompt-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if(Le)return void function(){const e=document.getElementById("timer-settings-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if(Ce)return void function(){const e=document.getElementById("burst-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if(Se)return void function(){const e=document.getElementById("resolution-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelectorAll(".resolution-item");0!==t.length&&(Te=(Te-1+t.length)%t.length,Kt(t))}();if(xe)return void function(){if(!xe)return;const e=document.getElementById("settings-submenu");if(!e)return;0!==e.querySelectorAll(".menu-section-button").length&&(Be=Math.max(0,Be-1),Zt())}();if("flex"===(null==(e=document.getElementById("gallery-modal"))?void 0:e.style.display))return void function(){const e=document.getElementById("gallery-modal");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if("flex"===(null==(t=document.getElementById("image-viewer"))?void 0:t.style.display))return void function(){const e=document.getElementById("image-viewer");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if("flex"===(null==(n=document.getElementById("style-editor"))?void 0:n.style.display))return void nn();if("flex"===(null==(o=document.getElementById("queue-manager"))?void 0:o.style.display))return void function(){const e=document.getElementById("queue-manager");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.max(0,t.scrollTop-80))}();if(!u||"block"===c.style.display)return;const s=Date.now();s-It<500||(It=s,Et&&clearTimeout(Et),Et=setTimeout(()=>{let e=xn();const t=Tn();e=(e-1+t.length)%t.length,gt=Sn(e);const n=dt[gt];n&&Nt(re?"‚ö° NO MAGIC MODE":n.name),qo(),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:dt[gt].name,timestamp:Date.now()})),Et=null},50))}),window.addEventListener("scrollDown",()=>{var e,t,n,o;if("flex"===document.getElementById("style-editor").style.display)return void on();if(be)return void function(){if(!be)return;const e=document.getElementById("preset-list");if(!e)return;const t=e.querySelectorAll(".preset-item");0!==t.length&&(we=Math.min(t.length-1,we+1),Qt())}();if(a.isImportModalOpen)return void a.scrollImportDown();if(ve&&Ie)return void Ie.scrollTutorialDown();if(ke)return void tn();if(Ot)return void function(){if(!Ot||!Mt)return;const e=document.getElementById("visible-presets-list");if(!e)return;const t=e.querySelectorAll(".style-item");0!==t.length&&(At=Math.min(t.length-1,At+1),zn())}();if(fe&&Ee)return void function(){if(!fe||!Ee)return;const e=document.getElementById("menu-styles-list");if(!e)return;const t=e.querySelectorAll(".style-item");0!==t.length&&(he=Math.min(t.length-1,he+1),En())}();if(Ae)return void function(){const e=document.getElementById("motion-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if(Oe)return void function(){const e=document.getElementById("master-prompt-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if(Le)return void function(){const e=document.getElementById("timer-settings-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if(Ce)return void function(){const e=document.getElementById("burst-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".submenu-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if(Se)return void function(){const e=document.getElementById("resolution-submenu");if(!e||"flex"!==e.style.display)return;const t=e.querySelectorAll(".resolution-item");0!==t.length&&(Te=(Te+1)%t.length,Kt(t))}();if(xe)return void function(){if(!xe)return;const e=document.getElementById("settings-submenu");if(!e)return;const t=e.querySelectorAll(".menu-section-button");0!==t.length&&(Be=Math.min(t.length-1,Be+1),Zt())}();if("flex"===(null==(e=document.getElementById("gallery-modal"))?void 0:e.style.display))return void function(){const e=document.getElementById("gallery-modal");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".gallery-scroll-container");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if("flex"===(null==(t=document.getElementById("image-viewer"))?void 0:t.style.display))return void function(){const e=document.getElementById("image-viewer");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".viewer-controls");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if("flex"===(null==(n=document.getElementById("style-editor"))?void 0:n.style.display))return void on();if("flex"===(null==(o=document.getElementById("queue-manager"))?void 0:o.style.display))return void function(){const e=document.getElementById("queue-manager");if(!e||"flex"!==e.style.display)return;const t=e.querySelector(".queue-list");t&&(t.scrollTop=Math.min(t.scrollHeight-t.clientHeight,t.scrollTop+80))}();if(!u||"block"===c.style.display)return;const s=Date.now();s-It<500||(It=s,Et&&clearTimeout(Et),Et=setTimeout(()=>{let e=xn();e=(e+1)%Tn().length,gt=Sn(e);const t=dt[gt];t&&Nt(re?"‚ö° NO MAGIC MODE":t.name),qo(),"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({action:"preset_changed",preset:dt[gt].name,timestamp:Date.now()})),Et=null},50))}),window.onPluginMessage=function(e){e&&"processing"===e.status?r.textContent="AI is processing your image...":e&&"complete"===e.status?r.textContent="AI transformation complete!":e&&e.error&&(r.textContent="Error: "+e.error)},"undefined"!=typeof PluginMessageHandler&&PluginMessageHandler.postMessage(JSON.stringify({message:"AI Camera Styles initialized",pluginId:"com.r1.pixelart"}));let gs=!1;function ps(){if(!gs){gs=!0;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="0.5vh",e.style.paddingBottom="0.5vw")}}function ys(){setTimeout(()=>{const e=document.querySelectorAll(".style-input, .style-textarea");if(!Array.from(e).some(e=>e===document.activeElement)&&gs){gs=!1;const e=document.querySelector(".style-editor-body");e&&(e.style.gap="1vh",e.style.paddingBottom="1vw")}},100)}const hs=document.getElementById("style-name"),fs=document.getElementById("style-category"),Es=document.getElementById("style-message");function Is(){document.getElementById("style-editor").style.display="none",document.getElementById("style-name").value="",document.getElementById("style-message").value="";const e=document.getElementById("style-category");e&&(e.value=""),document.getElementById("delete-style").style.display="none",pt=-1}async function vs(){const e=document.getElementById("style-name").value.trim(),t=document.getElementById("style-message").value.trim(),n=document.getElementById("style-category").value.trim(),s=n?n.split(",").map(e=>e.trim().toUpperCase()).filter(e=>e.length>0):[];if(e&&t){if(pt>=0){const n=dt[pt].name;dt[pt]={name:e,category:s,message:t};const i=mt.some(e=>e.name===n),l=ut&&a.getImportedPresets().some(e=>e.name===n);if(i||l?await o.saveModification(n,{name:e,message:t,category:s}):await o.saveNewPreset({name:e,category:s,message:t}),n!==e){const t=Lt.indexOf(n);t>-1&&(Lt[t]=e,wn())}}else{const n={name:e,category:s,message:t};await o.saveNewPreset(n),dt.push(n),Lt.push(e),wn()}alert(pt>=0?`Preset "${e}" updated!`:`Preset "${e}" saved!`),Is(),_o()}else alert("Please fill in both name and AI prompt")}async function bs(){if(pt>=0&&dt.length>1&&await confirm("Delete this style?")){const e=dt[pt].name,t=mt.some(t=>t.name===e);ut&&a.getImportedPresets().some(t=>t.name===e)?await a.deletePreset(e):t?await o.saveDeletion(e):await o.removeModification(e),dt.splice(pt,1);const n=Lt.indexOf(e);n>-1&&(Lt.splice(n,1),wn());const s=pt===gt;if(pt===gt?gt=Math.max(0,pt-1):pt<gt&&(gt-=1),gt=Math.max(0,Math.min(gt,dt.length-1)),Cn(),s){const e=dt.filter(e=>Lt.includes(e.name));e.length>0?gt=dt.findIndex(t=>t.name===e[0].name):dt.length>0&&(gt=0)}const i=dt[gt];if(i&&!Lt.includes(i.name)){const e=dt.filter(e=>Lt.includes(e.name));e.length>0?gt=dt.findIndex(t=>t.name===e[0].name):dt.length>0&&(gt=0)}qo(),Gn(),Is();const l=document.querySelector(".styles-menu-scroll-container"),c=l?l.scrollTop:0;_o(),l&&requestAnimationFrame(()=>{l.scrollTop=c}),alert(`Preset "${e}" deleted successfully!`)}}async function ws(){if(qe<0)return;const e=document.getElementById("status"),t=document.getElementById("upload-viewer-image");try{t.disabled=!0,t.textContent="‚è≥",e&&(e.style.display="block",e.textContent="Getting server...");const n=await fetch("https://api.gofile.io/servers");if(!n.ok)throw new Error("Failed to get upload server");const o=await n.json();if("ok"!==o.status||!o.data||!o.data.servers||0===o.data.servers.length)throw new Error("No upload servers available");const s=o.data.servers[0].name;e&&(e.textContent="Uploading image...");const a=De[qe].imageBase64.split(",")[1],i=atob(a),l=new Array(i.length);for(let e=0;e<i.length;e++)l[e]=i.charCodeAt(e);const c=new Uint8Array(l),r=new Blob([c],{type:"image/png"}),d=new FormData;d.append("file",r,`magic-kamera-${Date.now()}.png`);const m=`https://${s}.gofile.io/uploadFile`,u=await fetch(m,{method:"POST",body:d});if(!u.ok)throw new Error("Upload failed - status: "+u.status);const g=await u.json();if("ok"!==g.status||!g.data||!g.data.downloadPage)throw new Error("Upload failed: "+(g.status||"unknown error"));const p=g.data.downloadPage;e&&(e.textContent="Upload successful!",setTimeout(()=>{e.style.display="none"},2e3)),function(e){const t=document.getElementById("qr-modal"),n=document.getElementById("qr-code-container"),o=document.getElementById("qr-url-text");if(!t||!n||!o)return;n.innerHTML="",new QRCode(n,{text:e,width:128,height:128,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),o.textContent=e,t.style.display="flex"}(p.trim())}catch(n){e&&(e.textContent="Upload failed: "+n.message,setTimeout(()=>{e.style.display="none"},4e3))}finally{t.disabled=!1,t.textContent="üì§"}}function Bs(){const e=document.getElementById("qr-modal");e&&(e.style.display="none")}function Ts(){const e=document.getElementById("qr-scanner-modal");e&&(e.style.display="none"),Ls(),function(){const e=document.getElementById("qr-scanner-video");if(e&&e.srcObject){e.srcObject.getTracks().forEach(e=>e.stop()),e.srcObject=null}}(),xs("Point camera at QR code...","")}function xs(e,t=""){const n=document.getElementById("qr-scanner-status");n&&(n.textContent=e,n.className="qr-scanner-status",t&&n.classList.add(t))}function Ss(e,t="info",n=3e3){const o=document.getElementById("gallery-status-message");o&&(o.textContent=e,o.className="gallery-status-message","error"===t?o.classList.add("error"):"success"===t&&o.classList.add("success"),o.style.display="block",setTimeout(()=>{o.style.display="none"},n))}function Cs(){ct||(ct=!0,it=setInterval(Os,500))}function Ls(){ct=!1,it&&(clearInterval(it),it=null)}function Os(){const e=document.getElementById("qr-scanner-video");if(!e||e.readyState!==e.HAVE_ENOUGH_DATA)return;const t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.videoWidth,t.height=e.videoHeight,n.drawImage(e,0,0,t.width,t.height);const o=n.getImageData(0,0,t.width,t.height),s=jsQR(o.data,o.width,o.height);s&&s.data?!function(e){try{const t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(t){return!1}}(s.data)?(Ls(),Ts(),Ss("Invalid QR code - must be a valid URL","error",4e3)):lt!==s.data&&(lt=s.data,xs("QR Code detected! Importing...","success"),Ls(),setTimeout(()=>{!async function(){if(!lt)return Ts(),void Ss("No QR code detected","error",3e3);try{xs("Downloading image...","");const t=lt.trim(),n=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/raw?url=",""];let o=null,s=null;for(let d=0;d<n.length;d++)try{const e=n[d]?n[d]+encodeURIComponent(t):t;xs(`Trying method ${d+1}/${n.length}...`,"");const s=new AbortController,a=setTimeout(()=>s.abort(),8e3);if(o=await fetch(e,{signal:s.signal}),clearTimeout(a),o.ok){xs("Download successful!","success");break}}catch(e){s=e;continue}if(!o||!o.ok)throw new Error("All download methods failed");xs("Reading image data...","");let a=await o.blob();const i=Math.round(a.size/1024);if(xs("Original size: "+i+"KB",""),a.type&&!a.type.startsWith("image/"))throw new Error("Not an image: "+a.type);xs("Optimizing image...","");const l=f[E];a=await async function(e,t=640,n=480,o=.85){return new Promise((s,a)=>{const i=new Image,l=URL.createObjectURL(e);i.onload=()=>{URL.revokeObjectURL(l);let e=i.width,c=i.height;if(e>t||c>n){const o=e/c;e>c?(e=t,c=e/o):(c=n,e=c*o)}const r=document.createElement("canvas");r.width=e,r.height=c;r.getContext("2d").drawImage(i,0,0,e,c),r.toBlob(e=>{e?s(e):a(new Error("Failed to compress image"))},"image/jpeg",o)},i.onerror=()=>{URL.revokeObjectURL(l),a(new Error("Failed to load image for resizing"))},i.src=l})}(a,l.width,l.height,.85);xs("Compressed: "+i+"KB ‚Üí "+Math.round(a.size/1024)+"KB",""),xs("Converting to base64...","");const c=await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Base64 conversion timeout"))},1e4),o=new FileReader;o.onloadend=()=>{clearTimeout(n),e(o.result)},o.onerror=()=>{clearTimeout(n),t(new Error("FileReader error"))},o.readAsDataURL(a)});xs("Saving to gallery...","");const r={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:c,timestamp:Date.now()};De.unshift(r),await Rt(r),xs("‚úÖ Import successful!","success"),lt=null,Ts(),await Ut(),Ss("Image imported successfully!","success",3e3)}catch(e){lt=null,Ts(),Ss("Import failed: "+e.message,"error",4e3)}}()},500)):xs("Scanning...","")}hs&&(hs.addEventListener("focus",ps),hs.addEventListener("blur",ys)),fs&&(fs.addEventListener("focus",ps),fs.addEventListener("blur",ys)),Es&&(Es.addEventListener("focus",ps),Es.addEventListener("blur",ys)),window.addEventListener("load",()=>{var e,t,n,o,s,i,l,c,d,m;In(),function(){try{const e=localStorage.getItem(V),t=localStorage.getItem(G);null!==e&&(j=e),null!==t&&(F="true"===t),vn();const n=localStorage.getItem(z);if(n){J=n;const e=document.getElementById("aspect-ratio-1-1"),t=document.getElementById("aspect-ratio-16-9");e&&(e.checked="1:1"===J),t&&(t.checked="16:9"===J);const o=document.getElementById("current-aspect-ratio-display");o&&(o.textContent="none"===J?"None":J)}}catch(e){}}(),function(){try{const e=localStorage.getItem(W);e&&(Y=JSON.parse(e))}catch(e){Y={}}}(),Uo();const u=document.getElementById("start-button");u&&u.addEventListener("click",()=>{!function(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain(),s=e.createBiquadFilter();n.type="square",n.frequency.setValueAtTime(2400,t),n.frequency.exponentialRampToValueAtTime(1800,t+.012),s.type="highpass",s.frequency.setValueAtTime(1500,t),o.gain.setValueAtTime(.5,t),o.gain.exponentialRampToValueAtTime(.001,t+.015),n.connect(s),s.connect(o),o.connect(e.destination),n.start(t),n.stop(t+.015);const a=e.createOscillator(),i=e.createGain(),l=e.createBiquadFilter();a.type="square",a.frequency.setValueAtTime(1200,t+.015),a.frequency.exponentialRampToValueAtTime(200,t+.023),l.type="bandpass",l.frequency.setValueAtTime(1500,t+.015),l.Q.setValueAtTime(2,t+.015),i.gain.setValueAtTime(.4,t+.015),i.gain.exponentialRampToValueAtTime(.001,t+.03),a.connect(l),l.connect(i),i.connect(e.destination),a.start(t+.015),a.stop(t+.03);const c=e.createOscillator(),r=e.createGain();c.type="triangle",c.frequency.setValueAtTime(400,t+.023),c.frequency.setValueAtTime(450,t+.027),c.frequency.setValueAtTime(380,t+.031),c.frequency.setValueAtTime(420,t+.035),r.gain.setValueAtTime(0,t+.023),r.gain.linearRampToValueAtTime(.15,t+.025),r.gain.exponentialRampToValueAtTime(.001,t+.04),c.connect(r),r.connect(e.destination),c.start(t+.023),c.stop(t+.04);const d=e.createOscillator(),m=e.createGain(),u=e.createBiquadFilter();d.type="square",d.frequency.setValueAtTime(800,t+.05),d.frequency.exponentialRampToValueAtTime(150,t+.06),u.type="bandpass",u.frequency.setValueAtTime(1e3,t+.05),u.Q.setValueAtTime(2,t+.05),m.gain.setValueAtTime(.5,t+.05),m.gain.exponentialRampToValueAtTime(.001,t+.07),d.connect(u),u.connect(m),m.connect(e.destination),d.start(t+.05),d.stop(t+.07);const g=e.createOscillator(),p=e.createGain(),y=e.createBiquadFilter();g.type="sine",g.frequency.setValueAtTime(180,t+.05),g.frequency.exponentialRampToValueAtTime(120,t+.095),y.type="lowpass",y.frequency.setValueAtTime(300,t+.05),p.gain.setValueAtTime(0,t+.05),p.gain.linearRampToValueAtTime(.2,t+.055),p.gain.exponentialRampToValueAtTime(.001,t+.105),g.connect(y),y.connect(p),p.connect(e.destination),g.start(t+.05),g.stop(t+.105);const h=.08*e.sampleRate,f=e.createBuffer(1,h,e.sampleRate),E=f.getChannelData(0);for(let T=0;T<h;T++){const e=.5*Math.sin(T/200)+.5;E[T]=(2*Math.random()-1)*e}const I=e.createBufferSource();I.buffer=f;const v=e.createBiquadFilter();v.type="bandpass",v.frequency.setValueAtTime(3e3,t+.07),v.Q.setValueAtTime(1,t+.07);const b=e.createGain();b.gain.setValueAtTime(0,t+.07),b.gain.linearRampToValueAtTime(.12,t+.075),b.gain.linearRampToValueAtTime(.12,t+.125),b.gain.exponentialRampToValueAtTime(.001,t+.15),I.connect(v),v.connect(b),b.connect(e.destination),I.start(t+.07),I.stop(t+.15);const w=e.createOscillator(),B=e.createGain();w.type="square",w.frequency.setValueAtTime(600,t+.145),w.frequency.exponentialRampToValueAtTime(100,t+.155),B.gain.setValueAtTime(.25,t+.145),B.gain.exponentialRampToValueAtTime(.001,t+.165),w.connect(B),B.connect(e.destination),w.start(t+.145),w.stop(t+.165)}catch(e){}}();const e=document.querySelector(".camera-body");e&&(e.style.transition="all 0.1s",e.style.boxShadow="0 0 50px rgba(255, 255, 255, 1)",setTimeout(()=>{e.style.boxShadow=""},100));const t=document.querySelector(".lens-inner");t&&(t.style.transition="all 0.05s",t.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout(()=>{t.style.transform="translate(-50%, -50%) scale(1)"},50)),setTimeout(()=>{Oo()},300)});const g=document.getElementById("burst-toggle");g&&g.addEventListener("click",bo);const p=document.getElementById("timer-toggle");p&&p.addEventListener("click",wo);const y=document.getElementById("random-toggle");y&&y.addEventListener("click",lo);const h=document.getElementById("motion-toggle");h&&h.addEventListener("click",An);const f=document.getElementById("menu-button");f&&f.addEventListener("click",_o);const v=document.getElementById("close-menu");v&&v.addEventListener("click",jo);const b=document.getElementById("jump-to-top");b&&b.addEventListener("click",Jo);const w=document.getElementById("jump-to-bottom");w&&w.addEventListener("click",Wo);const B=document.getElementById("settings-menu-button");B&&B.addEventListener("click",Fo);const T=document.getElementById("settings-back");T&&T.addEventListener("click",Vo);const x=document.getElementById("resolution-settings-button");x&&x.addEventListener("click",Qo);const S=document.getElementById("resolution-back");S&&S.addEventListener("click",Zo);const A=document.getElementById("burst-settings-button");A&&A.addEventListener("click",Ko);const P=document.getElementById("burst-back");P&&P.addEventListener("click",es);const D=document.getElementById("timer-settings-button");D&&D.addEventListener("click",Go);const R=document.getElementById("timer-settings-back");R&&R.addEventListener("click",zo);const _=document.getElementById("master-prompt-settings-button");_&&_.addEventListener("click",ts);const X=document.getElementById("master-prompt-back");X&&X.addEventListener("click",ns);const Q=document.getElementById("aspect-ratio-settings-button");Q&&Q.addEventListener("click",os);const Z=document.getElementById("aspect-ratio-back");Z&&Z.addEventListener("click",ss);const K=document.getElementById("aspect-ratio-1-1"),te=document.getElementById("aspect-ratio-16-9");K&&K.addEventListener("change",e=>{e.target.checked?(J="1:1",te&&(te.checked=!1)):J="none",ls(),as()}),te&&te.addEventListener("change",e=>{e.target.checked?(J="16:9",K&&(K.checked=!1)):J="none",ls(),as()});const se=document.getElementById("motion-settings-button");se&&se.addEventListener("click",kn);const ie=document.getElementById("motion-back");ie&&ie.addEventListener("click",Mn);const le=document.getElementById("visible-presets-settings-button");le&&le.addEventListener("click",Nn);const me=document.getElementById("visible-presets-back");me&&me.addEventListener("click",Pn);const ue=document.getElementById("preset-builder-button");ue&&ue.addEventListener("click",Dn);const ye=document.getElementById("preset-builder-back");ye&&ye.addEventListener("click",Rn);const he=document.getElementById("preset-builder-jump-up");he&&he.addEventListener("click",en);const Ee=document.getElementById("preset-builder-jump-down");Ee&&Ee.addEventListener("click",tn);const Be=document.getElementById("preset-builder-template");Be&&Be.addEventListener("change",Un);const Te=document.getElementById("preset-builder-name");Te&&Te.addEventListener("keypress",e=>{var t;"Enter"===e.key&&(e.preventDefault(),null==(t=document.getElementById("preset-builder-category"))||t.focus())});const Se=document.getElementById("preset-builder-category"),Ce=document.getElementById("category-autocomplete");if(Se&&Ce){const e=()=>{const e=Se.value,t=e.lastIndexOf(","),n=(t>=0?e.substring(t+1):e).trim().toUpperCase(),o=function(){const e=new Set;return dt.forEach(t=>{t.category&&Array.isArray(t.category)&&t.category.forEach(t=>{e.add(t.toUpperCase())})}),Array.from(e).sort()}(),s=n?o.filter(e=>e.includes(n)):o;s.length>0?(Ce.innerHTML=s.map(e=>`<div class="category-autocomplete-item" data-category="${e}">${e}</div>`).join(""),Ce.style.display="block"):Ce.style.display="none"},t=e=>{const t=Se.value,n=t.lastIndexOf(",");Se.value=n>=0?t.substring(0,n+1)+" "+e+", ":e+", ",Ce.style.display="none",Se.focus()};Se.addEventListener("input",e),Se.addEventListener("focus",e),Ce.addEventListener("click",e=>{if(e.target.classList.contains("category-autocomplete-item")){const n=e.target.getAttribute("data-category");t(n)}}),document.addEventListener("click",e=>{Se.contains(e.target)||Ce.contains(e.target)||(Ce.style.display="none")}),Se.addEventListener("keypress",e=>{var t;"Enter"===e.key&&(e.preventDefault(),Ce.style.display="none",null==(t=document.getElementById("preset-builder-template"))||t.focus())})}const Le=document.getElementById("preset-builder-save");Le&&Le.addEventListener("click",_n);const Oe=document.getElementById("preset-builder-clear");Oe&&Oe.addEventListener("click",qn);const Ae=document.getElementById("preset-builder-delete");Ae&&Ae.addEventListener("click",jn);document.querySelectorAll(".chip-section-header").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-section");if("options"===t){const e=document.getElementById("preset-options-section-content"),t=document.getElementById("preset-options-arrow");if(!e)return;const n="none"!==e.style.display;return e.style.display=n?"none":"block",void(t&&t.classList.toggle("expanded",!n))}const n=document.getElementById("section-"+t);if(!n)return;const o="block"===n.style.display;document.querySelectorAll(".chip-section-content").forEach(e=>{e.style.display="none"}),document.querySelectorAll(".chip-section-header").forEach(e=>{e.classList.remove("expanded")}),o||(n.style.display="block",e.classList.add("expanded"))})});document.querySelectorAll(".preset-chip").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.getAttribute("data-text"),n=document.getElementById("preset-builder-prompt"),o=n.value;o.trim()?n.value=o+" "+t:n.value=t,n.scrollTop=n.scrollHeight})});const ke=document.getElementById("preset-builder-quality");ke&&ke.addEventListener("change",e=>{const t=e.target.value;if(t){const n=document.getElementById("preset-builder-prompt"),o=n.value;o.trim()?n.value=o+" "+t:n.value=t,e.target.value="",n.scrollTop=n.scrollHeight}});const Me=document.getElementById("visible-presets-filter");Me&&(Me.addEventListener("input",e=>{kt=e.target.value,Fn()}),Me.addEventListener("focus",()=>{st=!0;const e=document.getElementById("visible-presets-category-hint");e&&(e.style.display="none")}),Me.addEventListener("blur",()=>{st=!1}));const Ne=document.getElementById("visible-presets-select-all");Ne&&Ne.addEventListener("click",()=>{const e=dt.filter(e=>!e.internal);Lt=e.map(e=>e.name),wn(),Fn(),Gn(),fe&&ds()});const Pe=document.getElementById("visible-presets-deselect-all");Pe&&Pe.addEventListener("click",()=>{Lt=[],wn(),Fn(),Gn(),fe&&ds()});const je=document.getElementById("visible-presets-jump-up");je&&je.addEventListener("click",()=>{At=0,zn()});const ze=document.getElementById("visible-presets-jump-down");ze&&ze.addEventListener("click",()=>{const e=document.getElementById("visible-presets-list");if(e){const t=e.querySelectorAll(".style-item");t.length>0&&(At=t.length-1,zn())}});let Je=null,Ke=null,et=null,tt=[],nt=0,it=0,lt=0,ct=!1;function rt(){et&&Je&&(Je.width=et.width,Je.height=et.height,Ke.clearRect(0,0,Je.width,Je.height),Ke.drawImage(et,0,0),0===it&&0===lt||function(){const e=Ke.getImageData(0,0,Je.width,Je.height),t=e.data,n=it,o=(lt+100)/100;for(let s=0;s<t.length;s+=4)t[s]=255*((t[s]/255-.5)*o+.5),t[s+1]=255*((t[s+1]/255-.5)*o+.5),t[s+2]=255*((t[s+2]/255-.5)*o+.5),t[s]+=n,t[s+1]+=n,t[s+2]+=n,t[s]=Math.max(0,Math.min(255,t[s])),t[s+1]=Math.max(0,Math.min(255,t[s+1])),t[s+2]=Math.max(0,Math.min(255,t[s+2]));Ke.putImageData(e,0,0)}())}function mt(){const e={image:et,rotation:nt,brightness:it,contrast:lt};tt.push(e),ut()}function ut(){document.getElementById("undo-edit-button").disabled=0===tt.length}function pt(){document.getElementById("image-editor-modal").style.display="none",document.getElementById("image-viewer").style.display="flex",ct=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active")}null==(e=document.getElementById("edit-viewer-image"))||e.addEventListener("click",function(){const e=De[qe];if(!e)return;document.getElementById("image-viewer").style.display="none",document.getElementById("image-editor-modal").style.display="flex",Je=document.getElementById("editor-canvas"),Ke=Je.getContext("2d",{willReadFrequently:!0});const t=new Image;t.onload=()=>{et=t,tt=[],nt=0,it=0,lt=0,document.getElementById("brightness-slider").value=0,document.getElementById("contrast-slider").value=0,document.getElementById("brightness-value").textContent="0",document.getElementById("contrast-value").textContent="0",rt(),ut()},t.src=e.imageBase64}),null==(t=document.getElementById("close-image-editor"))||t.addEventListener("click",pt),null==(n=document.getElementById("rotate-button"))||n.addEventListener("click",function(){mt(),nt=(nt+90)%360;const e=document.createElement("canvas"),t=e.getContext("2d");90===nt||270===nt?(e.width=et.height,e.height=et.width):(e.width=et.width,e.height=et.height),t.translate(e.width/2,e.height/2),t.rotate(nt*Math.PI/180),t.drawImage(et,-et.width/2,-et.height/2);const n=new Image;n.onload=()=>{et=n,rt()},n.src=e.toDataURL("image/jpeg",.95)}),null==(o=document.getElementById("sharpen-button"))||o.addEventListener("click",function(){mt();const e=Ke.getImageData(0,0,Je.width,Je.height),t=e.data,n=Je.width,o=Je.height,s=new Uint8ClampedArray(t),a=[0,-1,0,-1,5,-1,0,-1,0];for(let l=1;l<o-1;l++)for(let e=1;e<n-1;e++)for(let o=0;o<3;o++){let i=0;for(let s=-1;s<=1;s++)for(let c=-1;c<=1;c++){const r=3*(s+1)+(c+1);i+=t[4*((l+s)*n+(e+c))+o]*a[r]}s[4*(l*n+e)+o]=Math.max(0,Math.min(255,i))}for(let l=0;l<t.length;l+=4)t[l]=s[l],t[l+1]=s[l+1],t[l+2]=s[l+2];Ke.putImageData(e,0,0);const i=new Image;i.onload=()=>{et=i,rt()},i.src=Je.toDataURL("image/jpeg",.95)}),null==(s=document.getElementById("autocorrect-button"))||s.addEventListener("click",function(){mt();const e=Ke.getImageData(0,0,Je.width,Je.height),t=e.data,n=1.15;for(let s=0;s<t.length;s+=4){let e=t[s],o=t[s+1],a=t[s+2];e=255*((e/255-.5)*n+.5),o=255*((o/255-.5)*n+.5),a=255*((a/255-.5)*n+.5);const i=.2989*e+.587*o+.114*a;e=i+1.2*(e-i),o=i+1.2*(o-i),a=i+1.2*(a-i),e+=5,o+=5,a+=5,t[s]=Math.max(0,Math.min(255,e)),t[s+1]=Math.max(0,Math.min(255,o)),t[s+2]=Math.max(0,Math.min(255,a))}Ke.putImageData(e,0,0);const o=new Image;o.onload=()=>{et=o,rt()},o.src=Je.toDataURL("image/jpeg",.95)}),null==(i=document.getElementById("undo-edit-button"))||i.addEventListener("click",function(){if(0===tt.length)return;const e=tt.pop();et=e.image,nt=e.rotation,it=e.brightness,lt=e.contrast,document.getElementById("brightness-slider").value=it,document.getElementById("contrast-slider").value=lt,document.getElementById("brightness-value").textContent=it,document.getElementById("contrast-value").textContent=lt,rt(),ut()}),null==(l=document.getElementById("save-edit-button"))||l.addEventListener("click",async function(){const e=document.createElement("canvas");e.width=Je.width,e.height=Je.height,e.getContext("2d").drawImage(Je,0,0);const t=e.toDataURL("image/jpeg",.9),n={id:Date.now().toString()+"-"+Math.random().toString(36).substr(2,9),imageBase64:t,timestamp:Date.now()};De.unshift(n),await Rt(n),qe=0;const o=document.getElementById("viewer-image");o.src=t,o.style.transform="scale(1) translate(0, 0)",He=1,pt(),await Ut(),Ss("Edited image saved!","success",3e3)}),null==(c=document.getElementById("crop-button"))||c.addEventListener("click",()=>{ct?function(){if(!ct)return;mt(),document.querySelector(".editor-image-container").getBoundingClientRect();const e=Je.getBoundingClientRect(),t=document.querySelector(".crop-top-left"),n=document.querySelector(".crop-bottom-right"),o=t.getBoundingClientRect(),s=n.getBoundingClientRect(),a=o.left-e.left,i=o.top-e.top,l=s.right-e.left-a,c=s.bottom-e.top-i;if(l<=0||c<=0)return void alert("Invalid crop area");const r=et.width/e.width,d=et.height/e.height,m=a*r,u=i*d,g=l*r,p=c*d,y=document.createElement("canvas");y.width=g,y.height=p,y.getContext("2d").drawImage(et,m,u,g,p,0,0,g,p);const h=new Image;h.onload=()=>{et=h,ct=!1,document.getElementById("crop-overlay").style.display="none",document.getElementById("crop-button").classList.remove("active"),rt()},h.src=y.toDataURL("image/jpeg",.95)}():function(){ct=!ct;const e=document.getElementById("crop-overlay"),t=document.getElementById("crop-button");if(ct){e.style.display="block",t.classList.add("active");const n=document.querySelector(".editor-image-container").getBoundingClientRect(),o=Je.getBoundingClientRect(),s=document.querySelector(".crop-top-left"),a=document.querySelector(".crop-bottom-right");s.style.left=o.left-n.left+.1*o.width+"px",s.style.top=o.top-n.top+.1*o.height+"px",a.style.right=n.right-o.right+.1*o.width+"px",a.style.bottom=n.bottom-o.bottom+.1*o.height+"px"}else e.style.display="none",t.classList.remove("active")}()}),null==(d=document.getElementById("brightness-slider"))||d.addEventListener("input",e=>{it=parseInt(e.target.value),document.getElementById("brightness-value").textContent=it,rt()}),null==(m=document.getElementById("contrast-slider"))||m.addEventListener("input",e=>{lt=parseInt(e.target.value),document.getElementById("contrast-value").textContent=lt,rt()});let yt=null;document.querySelectorAll(".crop-corner").forEach(e=>{e.addEventListener("touchstart",t=>{t.preventDefault(),yt=e})}),document.addEventListener("touchmove",e=>{if(!yt||!ct)return;e.preventDefault();const t=e.touches[0],n=document.querySelector(".editor-image-container").getBoundingClientRect(),o=Je.getBoundingClientRect();let s=t.clientX-n.left,a=t.clientY-n.top;const i=o.left-n.left,l=o.top-n.top,c=o.right-n.left,r=o.bottom-n.top,d=yt.offsetWidth;if(yt.classList.contains("crop-top-left")){s=Math.max(i,Math.min(s,c-d)),a=Math.max(l,Math.min(a,r-d));const e=document.querySelector(".crop-bottom-right").getBoundingClientRect(),t=e.right-n.left-2*d,o=e.bottom-n.top-2*d;s=Math.min(s,t),a=Math.min(a,o),yt.style.left=s+"px",yt.style.top=a+"px"}else if(yt.classList.contains("crop-bottom-right")){s=Math.max(i+d,Math.min(s,c)),a=Math.max(l+d,Math.min(a,r));const e=document.querySelector(".crop-top-left").getBoundingClientRect(),t=e.right-n.left+d,o=e.bottom-n.top+d;s=Math.max(s,t),a=Math.max(a,o),yt.style.right=n.width-s+"px",yt.style.bottom=n.height-a+"px"}}),document.addEventListener("touchend",()=>{yt=null});const ht=document.getElementById("motion-sensitivity-slider"),ft=document.getElementById("motion-sensitivity-value");if(ht&&ft){const e=["Very Low","Low","Medium","High","Very High"];ht.addEventListener("input",t=>{const n=parseInt(t.target.value);ft.textContent=e[n-1],ee=50-10*n,Wn(),Jn()})}const Et=document.getElementById("motion-continuous-enabled");Et&&Et.addEventListener("change",e=>{ne=e.target.checked,Wn()});const It=document.getElementById("motion-cooldown-slider"),vt=document.getElementById("motion-cooldown-value");It&&vt&&It.addEventListener("input",e=>{oe=parseInt(e.target.value),vt.textContent=`${oe}s`,Wn()});const Tt=document.getElementById("motion-start-delay-slider"),xt=document.getElementById("motion-start-delay-value");Tt&&xt&&Tt.addEventListener("input",e=>{const t=parseInt(e.target.value);ae=ce[t].seconds,xt.textContent=ce[t].label,Wn()});const St=document.getElementById("no-magic-toggle-button");St&&St.addEventListener("click",Xn);const Ct=document.getElementById("tutorial-button");Ct&&Ct.addEventListener("click",eo);const Ot=document.getElementById("tutorial-back");Ot&&Ot.addEventListener("click",async()=>{Ie&&(Ie.closeTutorial(),Ie.isTutorialOpenState(),ve=Ie.isTutorialSubmenuOpenState())});const Mt=document.getElementById("import-presets-button");Mt&&Mt.addEventListener("click",async()=>{try{const e=await a.import();if(e.success){const t=new Set(dt.map(e=>e.name));dt=await bn();const n=new Set(dt.map(e=>e.name));Lt=Lt.filter(e=>n.has(e)),dt.forEach(e=>{t.has(e.name)||Lt.includes(e.name)||Lt.push(e.name)}),wn(),ds(),Gn();const o=document.getElementById("styles-count");if(o){const e=dt.filter(e=>Lt.includes(e.name)).length;o.textContent=e}alert(e.message)}else"cancelled"!==e.message&&"No presets selected"!==e.message&&alert("Import failed: "+e.message)}catch(e){alert("Import error: "+e.message)}});document.querySelectorAll(".glossary-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-section");showTutorialSection(t)})});const Nt=document.getElementById("back-to-glossary");Nt&&Nt.addEventListener("click",()=>{Ie&&Ie.showGlossary&&Ie.showGlossary()});const qt=document.getElementById("master-prompt-enabled");qt&&qt.addEventListener("change",e=>{F=e.target.checked;const t=document.getElementById("master-prompt-text");t&&(t.disabled=!F),ls();const n=document.getElementById("master-prompt-indicator");n&&(n.style.display=F?"block":"none"),is()});const Ht=document.getElementById("master-prompt-text");Ht&&Ht.addEventListener("input",e=>{j=e.target.value;const t=document.getElementById("master-prompt-char-count");t&&(t.textContent=j.length),ls(),is()});const $t=document.getElementById("style-filter");let zt=null;$t&&($t.addEventListener("input",e=>{Qe=e.target.value,zt&&clearTimeout(zt),zt=setTimeout(()=>{ds()},150)}),$t.addEventListener("focus",()=>{ot=!0;const e=document.getElementById("menu-category-hint");e&&(e.style.display="none")}),$t.addEventListener("blur",()=>{ot=!1}));const Zt=document.getElementById("burst-count-slider"),Kt=document.getElementById("burst-speed-slider");Zt&&Zt.addEventListener("input",e=>{L=parseInt(e.target.value),document.getElementById("burst-count-value").textContent=L;const t=parseInt(Kt.value);vo(L,t),Xo(),C&&(r.textContent=re?"‚ö° NO MAGIC MODE ‚Ä¢ üì∏ Burst Mode":`Burst mode ON (${L} photos) ‚Ä¢ ${dt[gt].name}`)}),Kt&&Kt.addEventListener("input",e=>{const t=parseInt(e.target.value);O=k[t].delay,document.getElementById("burst-speed-value").textContent=k[t].label,vo(L,t),Xo()});const nn=document.getElementById("timer-delay-slider"),on=document.getElementById("timer-delay-value");nn&&on&&nn.addEventListener("input",e=>{const t=parseInt(e.target.value)-1;q=$[t],on.textContent=q,xo(),So()});const cn=document.getElementById("timer-repeat-enabled");cn&&cn.addEventListener("change",e=>{H=e.target.checked,xo(),So()});const mn=document.getElementById("timer-repeat-interval-input"),En=document.getElementById("timer-repeat-interval-unit");if(mn&&En){const e=()=>{const e=parseInt(mn.value)||1,t=parseInt(En.value);U=e*t,xo(),So()};mn.addEventListener("input",e),En.addEventListener("change",e)}!function(){try{const e=localStorage.getItem(M);if(e){const t=JSON.parse(e);L=t.count||5;const n=t.speed||2;O=k[n].delay}}catch(e){}}(),function(){try{const e=localStorage.getItem(N);if(e){const t=JSON.parse(e);q=t.delay||10,H=t.repeat||!1,U=t.repeatInterval||1}}catch(e){}}(),Yn(),function(){try{const e=localStorage.getItem(de);if(null!==e){re=JSON.parse(e);const t=document.getElementById("no-magic-status");t&&(t.textContent=re?"Enabled":"Disabled",t.style.color=re?"#4CAF50":"",t.style.fontWeight=re?"600":""),Qn()}}catch(e){}}(),function(){const e=localStorage.getItem(I);null!==e&&(E=parseInt(e,10)),Zn()}();const Bn=document.getElementById("reset-button");Bn&&Bn.addEventListener("click",Ho);const Tn=document.getElementById("camera-button");Tn&&Tn.addEventListener("click",Io);const xn=document.getElementById("close-editor");xn&&xn.addEventListener("click",Is);const Sn=document.getElementById("import-resolution-settings-button");Sn&&Sn.addEventListener("click",oo);const Cn=document.getElementById("import-resolution-back");Cn&&Cn.addEventListener("click",so);const Ln=document.getElementById("save-style");Ln&&Ln.addEventListener("click",vs);const On=document.getElementById("delete-style");On&&On.addEventListener("click",bs),bt=document.getElementById("connection-status"),wt=document.getElementById("queue-status"),Bt=document.getElementById("sync-button"),Bt&&Bt.addEventListener("click",No),wt&&wt.addEventListener("click",Po);const Hn=document.getElementById("close-queue-manager");Hn&&Hn.addEventListener("click",Do);const $n=document.getElementById("sync-all");$n&&$n.addEventListener("click",No);const Vn=document.getElementById("clear-queue");Vn&&Vn.addEventListener("click",Ro);const Kn=document.getElementById("gallery-button");Kn&&Kn.addEventListener("click",Ut);const to=document.getElementById("close-gallery");to&&to.addEventListener("click",_t);const no=document.getElementById("gallery-import-button");no&&no.addEventListener("click",()=>{!function(){const e=document.getElementById("qr-scanner-modal"),t=document.getElementById("qr-scanner-video");if(!e||!t)return;e.style.display="flex",async function(){const e=document.getElementById("qr-scanner-video");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});e.srcObject=t,e.onloadedmetadata=()=>{e.pause(),xs("Ready to scan","")}}catch(t){xs("Camera access denied","error")}}(),xs("Ready to scan","");const n=document.getElementById("qr-scan-button");n&&(n.disabled=!1)}()});const ao=document.getElementById("check-updates-button");ao&&ao.addEventListener("click",async()=>{try{const e=await fetch("./presets.json");if(!e.ok)return void alert("Could not load presets.json");const t=await e.json(),n=a.getImportedPresets();if(0===n.length)return void alert('No presets imported yet. Use "Import Presets" first.');let o=0,s=0;const i=new Set(n.map(e=>e.name));if(t.forEach(e=>{if(i.has(e.name)){const t=n.find(t=>t.name===e.name);t&&t.message!==e.message&&o++}else s++}),0===o&&0===s)return void alert("‚úÖ All presets are up to date!");const l=[];o>0&&l.push(`${o} updated preset(s)`),s>0&&l.push(`${s} new preset(s)`);if(await confirm(`Found ${l.join(" and ")} available.\n\nWould you like to import updates now?`)){const e=await a.import();if(e.success){const t=new Set(dt.map(e=>e.name));dt=await bn();const n=new Set(dt.map(e=>e.name));Lt=Lt.filter(e=>n.has(e)),dt.forEach(e=>{t.has(e.name)||Lt.includes(e.name)||Lt.push(e.name)}),wn(),ds(),Gn();const o=document.getElementById("updates-status");o&&(o.textContent="Check for Updates",o.style.color="",o.style.fontWeight=""),alert(e.message)}}}catch(e){alert("Error checking for updates: "+e.message)}});const io=document.getElementById("close-qr-scanner");io&&io.addEventListener("click",()=>{Ts()});const co=document.getElementById("close-viewer");co&&co.addEventListener("click",Jt);const ro=document.getElementById("delete-viewer-image");ro&&ro.addEventListener("click",Wt);const mo=document.getElementById("upload-viewer-image");mo&&mo.addEventListener("click",ws);const uo=document.getElementById("mp-viewer-button");uo&&uo.addEventListener("click",()=>{pe=qe,document.getElementById("image-viewer").style.display="none",document.getElementById("gallery-modal").style.display="none",ge=!0,document.getElementById("unified-menu").style.display="flex",fe=!0,document.getElementById("settings-submenu").style.display="flex",xe=!0,ts()});const go=document.getElementById("qr-scan-button");go&&go.addEventListener("click",()=>{const e=document.getElementById("qr-scan-button"),t=document.getElementById("qr-scanner-video");e&&(e.disabled=!0),t&&t.paused&&t.play(),xs("Scanning...",""),Cs()});const po=document.getElementById("close-qr-modal");po&&po.addEventListener("click",Bs);const yo=document.getElementById("gallery-start-date-btn"),ho=document.getElementById("gallery-start-date");yo&&ho&&(yo.addEventListener("click",()=>{ho.showPicker()}),ho.addEventListener("change",e=>{Fe=e.target.value||null,Gt("start",Fe),Vt()}));const fo=document.getElementById("gallery-end-date-btn"),Eo=document.getElementById("gallery-end-date");fo&&Eo&&(fo.addEventListener("click",()=>{Eo.showPicker()}),Eo.addEventListener("change",e=>{Ve=e.target.value||null,Gt("end",Ve),Vt()}));const Bo=document.getElementById("gallery-sort-order");Bo&&Bo.addEventListener("change",e=>{Ge=e.target.value;try{localStorage.setItem(Re,Ge)}catch(t){}Vt()});const To=document.getElementById("prev-page");To&&To.addEventListener("click",Ft);const Co=document.getElementById("next-page");Co&&Co.addEventListener("click",jt);const Lo=document.getElementById("load-preset-button");Lo&&Lo.addEventListener("click",Yt);const Ao=document.getElementById("multi-preset-button");Ao&&Ao.addEventListener("click",()=>{if(qe>=0){!function(e){Xe=e,Ye=[],We=!0;const t=document.getElementById("preset-selector");t.querySelector(".preset-selector-header h3").innerHTML='Select Presets <span id="multi-preset-count" style="font-size: 12px; color: #666;">(0 selected)</span>';let n=document.getElementById("multi-preset-controls");if(!n){n=document.createElement("div"),n.id="multi-preset-controls",n.style.cssText="padding: 0 8px; background: #f5f5f5; border-bottom: 1px solid #ddd; display: flex; gap: 8px; justify-content: space-between; align-items: stretch;",n.innerHTML='\n      <button id="multi-preset-apply" class="batch-control-button" style="background: #4CAF50; color: white;">Apply Selected</button>\n      <button id="multi-preset-cancel" class="batch-control-button">Cancel</button>\n    ';const e=document.getElementById("preset-filter"),t=document.getElementById("preset-list");e.parentNode.insertBefore(n,e),e.parentNode.insertBefore(e,t)}n.style.display="flex",sn(),pn(),t.style.display="flex",be=!0,we=0,Qt(),document.getElementById("multi-preset-apply").onclick=hn,document.getElementById("multi-preset-cancel").onclick=yn}(De[qe].id)}});const ko=document.getElementById("close-preset-selector");ko&&ko.addEventListener("click",Xt);const Mo=document.getElementById("preset-filter");Mo&&(Mo.addEventListener("input",e=>{Ze=e.target.value,sn()}),Mo.addEventListener("focus",()=>{at=!0;const e=document.getElementById("preset-selector-category-hint");e&&(e.style.display="none");const t=document.getElementById("multi-preset-controls");t&&(t.style.display="none")}),Mo.addEventListener("blur",()=>{if(at=!1,We){const e=document.getElementById("multi-preset-controls");e&&(e.style.display="flex")}}));const qo=document.getElementById("preset-selector-jump-up");qo&&qo.addEventListener("click",()=>{we=0,Qt()});const $o=document.getElementById("preset-selector-jump-down");$o&&$o.addEventListener("click",()=>{const e=document.getElementById("preset-list");if(e){const t=e.querySelectorAll(".preset-item");t.length>0&&(we=t.length-1,Qt())}});const Yo=document.getElementById("magic-button");Yo&&Yo.addEventListener("click",an);const cs=document.getElementById("batch-mode-toggle");cs&&cs.addEventListener("click",ln);const rs=document.getElementById("batch-select-all");rs&&rs.addEventListener("click",rn);const ms=document.getElementById("batch-deselect-all");ms&&ms.addEventListener("click",dn);const us=document.getElementById("batch-cancel");us&&us.addEventListener("click",ln);const gs=document.getElementById("batch-apply-preset");gs&&gs.addEventListener("click",un);const ps=document.getElementById("batch-delete");ps&&ps.addEventListener("click",gn),Pt().then(async()=>{localStorage.getItem("r1_gallery_index")?await async function(){try{const e=localStorage.getItem("r1_gallery_index");if(!e)return;const t=JSON.parse(e);let n=0;for(const o of t){const e="r1_gallery_"+o,t=localStorage.getItem(e);if(t){const o=JSON.parse(t);for(const e of o)await Rt(e),n++;localStorage.removeItem(e)}}localStorage.removeItem("r1_gallery_index"),await Dt()}catch(e){}}():await Dt()}).catch(e=>{}),function(){const e=document.getElementById("viewer-image"),t=document.querySelector(".image-viewer-container");let n=0,o=0,s=0,a=0,i=!1;t.addEventListener("touchstart",e=>{2===e.touches.length?(e.preventDefault(),$e=!0,Ue=fn(e.touches[0],e.touches[1]),_e=He):1===e.touches.length&&He>1&&(i=!0,s=e.touches[0].clientX-n,a=e.touches[0].clientY-o)},{passive:!1}),t.addEventListener("touchmove",t=>{if($e&&2===t.touches.length){t.preventDefault();const s=fn(t.touches[0],t.touches[1])/Ue;He=Math.max(1,Math.min(_e*s,5)),e.style.transform=`scale(${He}) translate(${n}px, ${o}px)`}else i&&1===t.touches.length&&He>1&&(t.preventDefault(),n=t.touches[0].clientX-s,o=t.touches[0].clientY-a,e.style.transform=`scale(${He}) translate(${n}px, ${o}px)`)},{passive:!1}),t.addEventListener("touchend",t=>{t.touches.length<2&&($e=!1),0===t.touches.length&&(i=!1,1===He&&(n=0,o=0,e.style.transform="scale(1) translate(0, 0)"))}),t.addEventListener("touchcancel",()=>{$e=!1,i=!1})}()}),window.removeFromQueue=async function(e){await confirm("Remove this photo from the sync queue?")&&(ht.splice(e,1),co(),mo(),Po())},window.previewQueueItem=function(e){const t=ht[e];alert(`Style: ${t.preset.name}\nPrompt: ${t.preset.message}\nSaved: ${new Date(t.timestamp).toLocaleString()}`)},window.clearQueue=Ro,document.getElementById("factory-reset-button").addEventListener("click",async()=>{const e=ut?"This will delete ALL custom presets and undo ALL modifications, returning to your clean imported preset list. This cannot be undone. Continue?":"This will delete ALL custom presets and restore all presets to their original state. This cannot be undone. Continue?";if(await confirm(e)){await o.clearAll(),dt=await bn(),dt.length>0&&(Lt=dt.map(e=>e.name),wn()),renderMenuStyles();alert(ut?"All custom presets deleted and modifications cleared. Reset to imported presets!":"All custom presets deleted and modifications cleared!")}}),document.addEventListener("DOMContentLoaded",function(){const e=document.querySelector(".mode-carousel-track");if(e){e.querySelectorAll(".mode-button").forEach(e=>{const t=e.getAttribute("data-mode");"random"===t?e.addEventListener("click",lo):"motion"===t?e.addEventListener("click",An):"burst"===t?e.addEventListener("click",bo):"timer"===t&&e.addEventListener("click",wo)})}});let As=0;document.addEventListener("touchstart",e=>{As=e.touches[0].clientX},{passive:!0}),document.addEventListener("touchend",e=>{const t=e.changedTouches[0].clientX,n=As-t,o=document.querySelector(".mode-carousel");if(!o)return;const s=.5*window.innerWidth;As>s&&n>30&&o.classList.add("show"),n<-30&&o.classList.remove("show")},{passive:!0});
